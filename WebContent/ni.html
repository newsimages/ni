<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport"
	content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=0" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<link rel="apple-touch-icon" href="icon.png" />
<link rel="apple-touch-startup-image" href="startup.png">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<title>Ni!</title>

<link href="dojo/dojox/mobile/themes/ios7/ios7.css" rel="stylesheet"></link>
<link
	href="dojo/dojox/mobile/themes/common/domButtons/DomButtonBlueInfo.css"
	rel="stylesheet"></link>
<link
	href="dojo/dojox/mobile/themes/common/domButtons/DomButtonDarkBlueCheck.css"
	rel="stylesheet"></link>
<link
	href="dojo/dojox/mobile/themes/common/domButtons/DomButtonGreySearch.css"
	rel="stylesheet"></link>

<script type="text/javascript" src="dojo/dojo/dojo.js"
	data-dojo-config="async:1, parseOnLoad:true, locale:'en-us'"></script>

<script>
	require(
			[ "dojo/ready", "dojo/parser", "dojo/has", "dojo/on", "dojo/touch",
					"dojo/keys", "dojo/_base/event", "dojo/aspect",
					"dojo/json", "dojo/_base/array", "dojo/_base/lang",
					"dojo/dom", "dojo/dom-construct", "dojo/dom-class",
					"dojo/request", "dojo/request/handlers", "dijit/registry", "dojox/mobile/ListItem",
					"dojox/mobile/ProgressIndicator",
					"dojox/mobile/viewRegistry", "dojox/mobile/ScrollableView",
					"dojox/mobile/ToolBarButton", "dojox/mobile",
					"js-unzip.js", "js-inflate.js", "unrar.js" ],
			function(ready, parser, has, on, touch, keys, event, aspect, json,
					array, lang, dom, domConstruct, domClass, request, handlers,
					registry, ListItem, Progressindicator, viewRegistry,
					ScrollableView, ToolBarButton, mobile, JSUnzip, JSInflate,
					unrar) {

				var showVideos = true;
				var showVideosWhileLoading = false;

				ToolBarButton.prototype.onTouchStart = function(e) {
					e.preventDefault();
				};

				var settings, serviceUrl;

				var defaultSettings = {
					servers : [],
					currentServer : -1,
					browse : false,
					searchFilter : "jpg",
					searchResultsCount : 100,
					getHeadersTimeout : 10,
					searchEngine : "BinSearch2",
					async : true,
					progress : true,
					partial : true,
					state : false,
					thumbnailSize : 150,
					slideshowDelay: 1000,
					optimizeImageDownload: true,
					listThumbnails: true
				};

				//---------- Initialization ----------

				function init() {

					// Compute service URL: same location as HTML + "/svc/".

					serviceUrl = document.location.href.substring(0,
							document.location.href.lastIndexOf("/"))
							+ "/svc/";

					initSettings();

					// Setup various listeners

					var enterHandler = function(e) {
						if ((e.keyCode || e.which) == keys.ENTER) {
							invisibleButton.domNode.focus();
						}
					};
					searchBox.on("keypress", enterHandler);
					filterBox.on("keypress", enterHandler);
					ngSearchBox.on("keypress", enterHandler);

					var bg = dom.byId("imageBackground");
					on(bg, touch.press, onImageTouchStart);
					on(bg, touch.move, onImageTouchMove);
					on(bg, touch.release, onImageTouchEnd);
					on(bg, has("ff") ? "DOMMouseScroll" : "mousewheel",
							onImageWheel);

					articleImage = dom.byId("articleImage");

					textView.domNode.style.visibility = "";

					initThumbnails();

					fitVideo();

					var ignoreScroll = false, nextImageLoaded = false;
					aspect.around(imageScroller, "onTouchMove", function(onTouchMove) {
						return function(e) {
							if (ignoreScroll) {
								return;
							}
							if (!imageRealSized) {
								var x = this.getPos().x,
									w = this.getDim().d.w,
									th = 100; 
								if (x >= th || x <= -th) {
									var f = x > 0 ? previous : next;
									var item = f(null, true);
									if(item){
										event.stop(e);
										ignoreScroll = true;
										nextImageLoaded = false;
										imageScroller.scrollTo({ x : x });
										imageScroller.slideTo({ x : x > 0 ? w : -w }, 0.3, "ease-out");
										setTimeout(function(){
											articleImage.style.visibility = "hidden";
											nextImageLoaded = true;
											showArticle(item);
										}, 290);
										return;
									}
								}
							}
							onTouchMove.call(this, e);
						};
					});
					aspect.around(imageScroller, "onTouchEnd", function(onTouchEnd) {
						return function(e) {
							if (ignoreScroll) {
								imageScroller.abort();
								if(!nextImageLoaded){
									articleImage.style.visibility = "hidden";
								}
								ignoreScroll = false;
								this._time = [];
							}
							onTouchEnd.call(this, e);
						};
					});

					document.onkeydown = function(e) {
						if (e.target.tagName == "INPUT")
							return;
						var k = e.keyCode || e.which;
						if (articleView.domNode.style.display != "none") {
							showArticleControls();
							switch (k) {
							case keys.BACKSPACE:
							case keys.ESCAPE:
								articleView.performTransition(
										articleBackButton.moveTo, -1, "slide");
								break;
							case keys.LEFT_ARROW:
							case keys.UP_ARROW:
								previous();
								break;
							case keys.RIGHT_ARROW:
							case keys.DOWN_ARROW:
							case keys.SPACE:
								next();
								break;
							}
							return;
						}
						var v = searchView.domNode.style.display != "none" ? searchView
								: (newsgroupView.domNode.style.display != "none" ? newsgroupView
										: (seriesView.domNode.style.display != "none" ? seriesView
												: (seriesView2.domNode.style.display != "none" ? seriesView2
											: null)));
						if (v) {
							switch (k) {
							case keys.BACKSPACE:
							case keys.ESCAPE:
								if(v === newsgroupView || v === seriesView || v === seriesView2){
									v.performTransition(v === seriesView ? seriesHeading.moveTo :
														v === seriesView2 ? seriesHeading2.moveTo :
														"search", -1, "slide");
								}
								break;
							case keys.UP_ARROW:
								scroll(v, 0.5);
								break;
							case keys.DOWN_ARROW:
								scroll(v, -0.5);
								break;
							case keys.PAGE_UP:
								scroll(v, 1);
								break;
							case keys.PAGE_DOWN:
								scroll(v, -1);
								break;
							case keys.SPACE:
								array
										.some(
												(v == searchView ? searchResultsList
														: newsgroupResultsList)
														.getChildren(),
												function(item) {
													if (item.domNode
															.getBoundingClientRect().top >= 30
															&& item.articleId) {

														selectArticle
																.call(item);
														return true;
													}
												});
								break;
							}
						}
					}

					// restore/clear state
					initState();
				}

				ready(init);

				//---------- Search ----------

				var searchTimer, ignoreBlur, clearTimer;

				clearSearchBox = function() {
					searchBox.set("value", "");
				};

				function updateClearIcon() {
					dom.byId("clearIcon").style.visibility = searchBox
							.get("value") ? "visible" : "hidden";
					clearTimer = setTimeout(updateClearIcon, 200);
				}

				function stopSearchTimer() {
					if (searchTimer) {
						clearTimeout(searchTimer);
						searchTimer = null;
					}
				}

				searchFocus = function() {
					ignoreBlur = false;
					cancelRequest();
					progress();
					stopSearchTimer();
					searchView.scrollTo({
						y : 0
					});
					domClass.add(searchOptions.domNode, "visible");
					updateClearIcon();
				}

				searchBlur = function() {
					if (ignoreBlur)
						return;
					stopSearchTimer();
					searchTimer = setTimeout(function() {
						hideSearchOptions();
						if (!ignoreBlur) {
							search();
						}
					}, 200);
					clearTimeout(clearTimer);
				}

				function hideSearchOptions() {
					invisibleButton.domNode.focus();
					domClass.remove(searchOptions.domNode, "visible");
				}

				search = function() {
					updateSearchSettings();
					ignoreBlur = true;
					hideSearchOptions();
					clearList(searchResultsList);
					var value = searchBox.get("value");
					clearState();
					record("setSearch", null, [ value ]);
					if (!value)
						return;
					if (/*value.indexOf(".") >= 0*/settings.browse) {
						// newsgroup browsing
						getNewsgroups(value);
					} else {
						// keyword search
						getSearchResults(value);
					}
				};

				cancelSearch = function() {
					ignoreBlur = true;
					hideSearchOptions();
				}

				function getSearchResults(value) {
					getArticles(
							"s",
							{
								engine : settings.searchEngine,
								pattern : value,
								filter : settings.searchFilter || " ",
								max : settings.searchResultsCount,
								age : (currentServer && currentServer.retention) || 1000,
							}, 0, true, searchResultsList, searchView);
				}

				//---------- Shared code b/w search and browsing ----------

				function getArticles(command, args, offset, reverse, list,
						view, item) {
					args.offset = offset;
					var onSuccess = function(result) {

						if (offset == 0) {
							clearRecords("getArticles");
						}
						clearRecords("selectArticle");
						record("getArticles", null, [command, args, offset, reverse, list, view, true], result);

						if (item) {
							if(item === true){
								var children = list.getChildren();
								if(children.length > 0){
									item = children[children.length-1];
								}
							}
							list.removeChild(item);
							if (item.prevItem) {
								item.prevItem.nextItem = null;
							}
						}
						var articles = ensureArray(result.articleList.articles);
						if (reverse && articles){
							articles = articles.slice();
							articles.reverse();
						}
						list.view = view;
						fillArticleList(list, articles, newsgroup, offset > 0);
						if (result.articleList.available > 0 && articles
								&& articles.length > 0) {
							var moreItem = new ListItem({
								label : "More...",
								clickable : true,
								noArrow : true,
								onClick : function() {
									getArticles(command, args,
											result.articleList.offset, reverse,
											list, view, this);
								}
							});
							moreItem.isMoreItem = true;
							view.autoLoadItem = moreItem;
							domClass.add(moreItem.domNode, "grayItem");
							var c = list.getChildren(), l = c.length;
							if (l > 0) {
								var prev = c[l - 1];
								prev.nextItem = moreItem;
								moreItem.prevItem = prev;
							}
							list.addChild(moreItem);
						}
						if (item && item.itemsLoaded) {
							item.itemsLoaded();
							item.itemsLoaded = null;
						}
					};

					doRequest(command, args, item || view, onSuccess);
				}

				function ensureArray(list) {
					return (!list || list instanceof Array) ? list : [ list ];
				}

				var itemId = 0;

				function uniqueId(id) {
					var uid = id;
					var n = 0;
					while (registry.byId(uid)) {
						uid = id + (++n);
					}
					return uid;
				}

				function fillArticleList(list, articles, newsgroup, noscroll) {
					if (!articles || articles.length == 0) {
						var noArticlesItem = new ListItem(
								{
									label : list.getChildren().length > 0 ? "No more articles found."
											: "No articles found."
								});
						domClass.add(noArticlesItem.domNode, "grayItem");
						list.addChild(noArticlesItem);
					} else {
						var children = list.getChildren();
						var item = children.length > 0 ? children[children.length - 1]
								: null;
						for (var i = 0; i < articles.length; i++) {
							var a = articles[i];
							var id = a.vols || a.parts || a.articleId;
							if(a.group){
								var a0 = a.group[0];
								var ga = lang.mixin({}, a0, {
									groupId: "group_" + (a0.vols || a0.parts || a0.articleId),
									subject: a.subject,
									key: a.key
								});
								var groupItem = item = addArticleItem(list, ga, gotoSeries, item);
								array.forEach(children, function(pitem) {
									if(pitem._key === a.key){
										domClass.add(pitem.domNode, "obsolete");
									}
								});
								list.addChild(groupItem);
								groupItem._subject = a.subject;
								addGroupItems(list, groupItem, a.group, "similar articles", newsgroup);
							} else {
								item = addArticleItem(list, a, selectArticle, item, newsgroup);
								list.addChild(item);
							}
						}
					}
					if (!noscroll) {
						viewRegistry.getEnclosingScrollable(list.domNode)
								.scrollTo({
									y : 0
								});
					}
				}
				
				function addGroupItems(list, groupItem, groupArticles, label, newsgroup){
					domClass.add(groupItem.domNode, "series");
					groupItem.noArrow = false;
					groupItem.setArrow();
					groupItem.onClick = gotoSeries;
					groupItem._duration = 200;
					groupItem._groupItems = [];
					groupItem.set("label", groupItem.label + "<div class='similar'>" + groupArticles.length + " " + label + "</div>")
					var subItem = null;
					for(var i = 0; i < groupArticles.length; i++){
						var a = groupArticles[i];
						subItem = addArticleItem(list, a, selectArticle, subItem, newsgroup);
						groupItem._groupItems.push(subItem);
						subItem._parentGroup = groupItem;
					}
				}
				
				function addArticleItem(list, a, callback, prevItem, newsgroup) {
					var id = a.vols || a.parts || a.articleId;
					var item = new ListItem(
								lang.mixin(a, {
									id : uniqueId(a.groupId || id),
									label : a.subject ,
									clickable : true,
									noArrow : true,
									onClick : callback,
									articleId : id,
									newsgroup : newsgroup
											|| (a.newsgroups instanceof Array ? a.newsgroups[0]
													: a.newsgroups),
									bytes : a.bytes,
									view : list.view,
									_duration: 800
								}));
					item._list = list;
					item._key = a.key;
					if (prevItem) {
						prevItem.nextItem = item;
						item.prevItem = prevItem;
					}
					return item;
				}
			
				var gotoSeriesCount = 0;
				
				function gotoSeries(evt, noTransition) {
					
					record("gotoSeries", this, []);
					
					var view, heading, list;
					if(gotoSeriesCount++ % 2 == 0){
						view = seriesView;
						heading = seriesHeading;
						list = seriesResultsList;
					} else {
						view = seriesView2;
						heading = seriesHeading2;
						list = seriesResultsList2;
					}
					
					heading.set("label", this._subject||this.label);
					heading.set("moveTo", this.view.id);
					if(this.view === seriesView || this.view === seriesView2){
						this.view._savedItems = (this.view === seriesView ? seriesResultsList : seriesResultsList2).getChildren();
					}
					var fromView = this.view.getShowingView();
					var oldCallback = fromView.onAfterTransitionOut;
					var f = function(){
						fromView.onAfterTransitionOut = oldCallback;
						fromView.getShowingView().performTransition(view.id, 1,
								(replaying||noTransition) ? "none" : "slide");
					}
					if(fromView._inProgress){
						fromView.onAfterTransitionOut = f;
					} else {
						f();
					}
					view.scrollTo({
						x : 0,
						y : 0
					});
					list.view = view;
					array.forEach(this._groupItems, function(child){
						list.addChild(child);
						child._list = list;
						child.view = view;
					});
					
					return list;
				}
				
				viewSeries = function() {
					var list = gotoSeries.call(currentItem, null, true);
					var items = list.getChildren();
					items[0].body = currentItem.body;
					record("getBody", null, [ {}, items[0] ], {
						articleBody : currentItem.body
					});
					markRead(items[0]);
					selectArticle.call(items[1], null, true);
				};
				
				leaveSeriesView = function(moveTo) {
					if (arguments[1] == -1) {
						var list = this === seriesView ? seriesResultsList : seriesResultsList2;
						while ((children = list.getChildren()).length > 0) {
							list.removeChild(children[0]);
						}
						if(--gotoSeriesCount == 0){
							clearRecords("gotoSeries");
							clearRecords("seriesScroll");
						} else {
							clearLastRecord("gotoSeries")
							clearLastRecord("seriesScroll")
						}
						if(moveTo === "series" || moveTo === "series2"){
							var view = moveTo === "series" ? seriesView : seriesView2;
							if(view._savedItems){
								list = view === seriesView ? seriesResultsList : seriesResultsList2;
								while ((children = list.getChildren()).length > 0) {
									list.removeChild(children[0]);
								}
								array.forEach(view._savedItems, function(item){
									list.addChild(item);
								});
							}
						}
					}				
					fixList(searchResultsList);
					fixList(newsgroupResultsList);
					fixList(seriesResultsList);
					fixList(seriesResultsList2);
				}
				
				//---------- Newsgroup browsing ----------

				var currentNewsgroup;

				function getNewsgroups(value) {
					if (!currentServer) {
						showMessage("No server defined");
						return;
					}
					doRequest("g", {
						pattern : "*" + value + "*",
						max : settings.searchResultsCount
					}, searchView,
					// success
					function(result) {
						record("getNewsgroups", null, arguments, result);
						fillNewsgroupList(searchResultsList,
								result.newsgroupList.newsgroups);
					});
				}

				function fillNewsgroupList(list, newsgroups) {
					if (!newsgroups || newsgroups.length == 0) {
						list.addChild(new ListItem({
							label : "No newsgroups found."
						}));
					} else {
						array.forEach(newsgroups, function(g) {
							list.addChild(new ListItem({
								id : uniqueId(g.name),
								label : g.name,
								clickable : true,
								noArrow : true,
								onClick : selectNewsgroup
							}));
						});
					}
					searchView.scrollTo({
						y : 0
					});
				}

				function selectNewsgroup() {
					clearRecords("selectNewsgroup");
					clearRecords("selectArticle");
					clearRecords("getBody");
					clearRecords("getArticles");
					record("selectNewsgroup", this, []);
					var newsgroup = currentNewsgroup = this.get("label");
					var l = newsgroup;
					if (l.length > 20) {
						l = l.replace(/(\w)\w*\./g, "$1.");
					}
					newsgroupHeading.set("label", l);
					ngSearchBox.set("value", "");
					searchView.performTransition("newsgroup", 1,
							replaying ? "none" : "slide");
					clearList(newsgroupResultsList);
					if (!replaying)
						getHeaders(newsgroup, 0);
				}

				function getHeaders(newsgroup, offset, filter) {
					getArticles("h", {
						newsgroup : newsgroup,
						filter : filter || " ",
						count : settings.searchResultsCount,
						timeout: settings.getHeadersTimeout,
					}, offset, false, newsgroupResultsList, newsgroupView);
				}

				newsgroupSearch = function() {
					var v = ngSearchBox.get("value");
					clearList(newsgroupResultsList);
					getHeaders(currentNewsgroup, 0, v);
				}

				//---------- Article ----------

				var currentItem, imageRealSized, articleImage, currentAsyncId;

				function selectArticle(evt, noTransition) {
					if (!currentServer) {
						showMessage("No server defined");
						return;
					}
					var view = this.view;
					view.performTransition("article", 1, (replaying || noTransition) ? "none" : "slide");
					articleBackButton.set("moveTo", view.id);
					textHeading.set("moveTo", view.id);
					showArticle(this);
				}
				
				function showArticle(item, noClear) {
					
					clearRecords("selectArticle");
					record("selectArticle", item, []);

					currentItem = item;

					domClass.remove(item.domNode, "error");

					dom.byId("leftArrow").style.visibility = previous(item, true) ? "inherit"
							: "hidden";
					dom.byId("rightArrow").style.visibility = next(item, true) ? "inherit"
							: "hidden";
					
					var seriesMessage = dom.byId("seriesMessage");
					if(item._groupItems){
						seriesMessage.innerHTML = item._groupItems.length;
						domClass.remove(seriesMessage, "hidden");
					} else {
						domClass.add(seriesMessage, "hidden");
					}

					setArticleTitle(item.get("label"));

					realSize(false);
					showImage();

					// try to get body from item first for multiple attachments
					var body = item.body;

					if (body) {
						cancelRequest();
						showProgressBar(false);
						showBody(item, body);
						return;
					}

					domClass.add(textButton.domNode, "disabled");

					var args = {
						articleId : item.articleId,
						screenSize: settings.optimizeImageDownload ?
										Math.max(mobile.getScreenSize().w, mobile.getScreenSize().h) :
											0
					};

					if (settings.async) { // async + progress
						var data = "";
						var filename;
						var multi;
						if (settings.partial) {
							loadImage("", true);
						}
						var f = function(id) {
							currentAsyncId = null;
							doRequest(
									"p",
									{
										id : id
									},
									null,
									function(result) {
										var p = result.progress;
										p.complete = p.complete == "true";
										showProgress(p, item.bytes);
										if (p.chunk) {
											data += p.chunk;
											if (p.attSizes) {
												// multiple attachments
												var attSizes = ensureArray(p.attSizes);
												multi = multi || [];
												var start = 0;
												for ( var i = multi.length; i < attSizes.length; i++) {
													var size = attSizes[i];
													if (typeof size == "string") {
														size = parseInt(size);
													}
													multi
															.push(data
																	.substring(
																			start,
																			start
																					+ size));
													start += size;
												}
												data = data.substring(start);
											}
										}
										if (p.filename) {
											filename = p.filename;
											var suff = suffix(p.filename);
											switch (suff) {
											case "jpg":
											case "gif":
											case "png":
												setImageTitle(p.filename);
												if (settings.partial && p.chunk) {
													loadImage(data, true);
												}
												break;
											case "mpg":
											case "mp4":
											case "avi":
											case "ogg":
											case "ogv":
												if (showVideos
														&& showVideosWhileLoading) {
													setVideoTitle(p.filename);
													if (settings.partial
															&& p.chunk) {
														loadVideo(data, false,
																p.filename);
														break;
													}
												}
											}
										}
										if (!p.complete) {
											f(id);
										} else {
											currentAsyncId = null;
											progress();
											showProgressBar(false);
											if (p.exception) {
												showError(p.exception);
											} else {
												if (p.body) {
													if (multi && data) {
														multi.push(data);
													}
													gotBody(item, p.body, multi
															|| [ data ]);
												} else {
													getBody(args, item);
												}
											}
										}
									}, function(err) {
										if (err.dojoType != "cancel") {
											progress();
											showProgressBar(false);
											showError(err);
										}
									});
							currentAsyncId = id;
						};
						progress(articleView);
						showProgressBar(true);
						doRequest("ba", args, null, f);
					} else {
						if(!slideshow)
							loadImage("");
						getBody(args, item);
					}
				}

				var startTime;

				function showProgress(progress, total) {
					startTime = startTime || new Date().getTime();
					if (progress.exception)
						showMessage(progress.exception);
					var percent = progress.complete ? 100 : progress.bytesRead
							/ total * 100;
					progressBar.set("value", percent + "%");
					if (percent >= 20 && !progress.exception && currentItem
							&& currentItem.domNode) {
						markRead(currentItem);
					}
					var b = progress.bytesRead, t = total;
					var k = 1024;
					var kb = b = Math.round(b / k);
					t = Math.round(t / k);
					var u = "Kb";
					if (t > 1024) {
						b = (b / k).toFixed(1);
						t = (t / k).toFixed(1);
						u = "Mb";
					}
					var label;
					if (progress.message) {
						label = progress.message;
					} else {
						label = b + " / " + t + " " + u;
						if (kb > 0) {
							var dt = new Date().getTime() - startTime;
							if (dt > 0) {
								var speed = (1000 * kb / dt).toFixed(1);
								label += " (" + speed + " " + "Kb/s)";
							}
						}
						if (progress.complete)
							startTime = 0;
						if (progress.partCount > 1) {
							label += " - part " + progress.part + " of "
									+ progress.partCount;
						}
					}
					progressBar.set("label", label);
				}

				leaveArticleView = function(to) {
					cancelRequest();
					startStopSlideshow(0);
					if (to == "index") {
						return;
					}
					hideArticle();
					showProgressBar(false);
					fixList(searchResultsList);
					fixList(newsgroupResultsList);
					fixList(seriesResultsList);
					fixList(seriesResultsList2);
					clearRecords("selectArticle");
				}

				leaveNewsgroupView = function() {
					if (arguments[1] == -1) {
						clearRecords("getArticles");
						clearRecords("getBody");
						clearRecords("selectNewsgroup");
						clearRecords("selectArticle");
						clearRecords("newsgroupScroll");
					}
					fixList(searchResultsList);
				}

				function fixList(list) {
					list.resize();
					ensureItemVisible(list, currentItem);
				}
				
				function ensureItemVisible(list, item) {
					if (item && item.getParent() == list) {
						var v = viewRegistry
								.getEnclosingScrollable(list.domNode), node = item.domNode, nodeRect = node
								.getBoundingClientRect(), scrollableRect = v.domNode
								.getBoundingClientRect();
						if (nodeRect.height < v.getDim().d.h) {
							if (nodeRect.top < (scrollableRect.top + v.fixedHeaderHeight)) {
								v.scrollIntoView(node, true);
							} else if ((nodeRect.top + nodeRect.height) > (scrollableRect.top
									+ scrollableRect.height - v.fixedFooterHeight)) {
								v.scrollIntoView(node, false);
							}
						}
					}
				}

				function showProgressBar(show) {
					if (settings.progress) {
						if (show) {
							showImage();
							progressBar.set("value", 0);
							progressBar.set("label", "");
						}
						domClass[show ? "add" : "remove"](progressBarParent,
								"visible");
					}
				}

				function getBody(args, item) {
					doRequest("b", args, articleView, function(result) {
						gotBody(item, result.articleBody);
					});
				}

				function gotBody(item, body, data) {

					if (!body.attachments)
						body.attachments = [];
					else if (!(body.attachments instanceof Array))
						body.attachments = [ body.attachments ];
					array.forEach(body.attachments, function(att, i) {
						if (data && data[i]) {
							att.data = data[i];
						}
					});

					// cache in memory for immediate reuse
					item.body = body;
					if(item._parentGroup && !item._parentGroup.body){
						item._parentGroup.body = body;
					}

					record("getBody", null, [ {}, item ], {
						articleBody : body
					});

					showBody(item, body);
				}

				function showBody(item, body) {

					markRead(item);
					domClass.remove(textButton.domNode, "disabled");

					if (body.articles != null) {
						// NZB index
						showIndex(ensureArray(body.articles), item);
					} else {
						var n = body.attachments.length;
						if (n > 1) {
							showMultipleAttachments(body.attachments, item);
						} else if (n == 1) {
							var att = body.attachments[0];
							if (att.filename) {
								var suff = suffix(att.filename);
								switch (suff) {
								case "jpg":
								case "gif":
								case "png":
									showImage(att);
									if(settings.listThumbnails){
										setListThumbnail(item, att.data);
									}
									break;
								case "mpg":
								case "mp4":
								case "avi":
								case "ogg":
								case "ogv":
									if (showVideos) {
										showVideo(att);
									} else {
										showText(body, null, att, "video/"
												+ suff);
									}
									break;
								case "zip":
								case "cbz":
									showZip(att, item);
									break;
								case "rar":
								case "cbr":
									showRar(att, item);
									break;
								case "txt":
									setArticleTitle(att.filename);
									showText(body, att.data);
									break;
								case "exe":
									showText(body, null, att,
											"application/x-msdownload");
									break;
								case "pdf":
									showText(body, null, att, "application/pdf");
									break;
								default:
									showText(body, null, att);
								}
							} else {
								showText(body);
							}
						} else {
							showText(body);
						}
					}
					
					doSlideshow();
				}
				
				function markRead(item) {
					domClass.add(item.domNode, "read");
					if(item._parentGroup){
						domClass.add(item._parentGroup.domNode, "read");
					}
				}
				
				function setListThumbnail(item, data){
					if(!item._listThumbnail){
						var th = document.createElement("div");
						domClass.add(th, "listThumbnailParent");
						var img = document.createElement("img");
						domClass.add(img, "listThumbnailImage");
						setImageSrc(img, data);
						th.appendChild(img);
						item.domNode.insertBefore(th, item.labelNode);
						item._listThumbnail = th;
					}
				}

				function showZip(att, item) {
					var unzipper = new JSUnzip(att.data);
					if (unzipper.isZipFile()) {
						unzipper.readEntries();
						var attachments = [];
						for ( var i = 0; i < unzipper.entries.length; i++) {
							var entry = unzipper.entries[i];
							var data;
							if (entry.compressionMethod === 0) {
								// Uncompressed
								data = entry.data;
							} else if (entry.compressionMethod === 8) {
								// Deflated
								data = JSInflate.inflate(entry.data);
							}
							if (data) {
								attachments.push({
									filename : entry.fileName,
									data : data
								});
							}
						}
						if (attachments.length > 0) {
							showMultipleAttachments(attachments, item);
						}
					}
				}

				function showRar(att, item) {
					progress(articleView);
					showProgressBar(true);
					progressBar.set("value", 0);
					progressBar.set("label", "Unpacking RAR archive...");
					currentUnrar = unrar(binaryToUint8Array(att.data).buffer, replaying);
					currentUnrar.then(function(attachments) {
						currentUnrar = null;
						showMultipleAttachments(attachments, item);
					}, function(err) {
						currentUnrar = null;
						progress();
						showProgressBar(false);
						showError(err);
					}, function(p) {
						progressBar.set("value", Math.round(p.index / p.total
								* 100)
								+ "%");
						progressBar.set("label", "Unpacking " + p.file + " ("
								+ p.index + "/" + p.total + ")");
					});
				}

				function showMultipleAttachments(attachments, item) {
					showMultipleItems(
							array
									.map(
											attachments,
											function(att, index) {
												var body = item.body||{};
												return {
													subject : att.filename,
													body : {
														from : body.from,
														date : body.date,
														newsgroups : body.newsgroups,
														text : "<p><span>Attachment "
																+ (index + 1)
																+ " of:</span><span style=\"font-style: italic\">"
																+ item.label
																+ "</span></p>",
														attachments : [ att ]
													}
												};
											}), item);
				}

				function showIndex(articles, item) {
					showMultipleItems(array.map(articles, function(a) {
						return {
							subject : a.subject,
							articleId : a.vols || a.parts || a.articleId,
							bytes : a.bytes
						};
					}), item);
				}

				function showMultipleItems(items, item) {
					var list = item._list;
					if(!item._groupItems){
						addGroupItems(list, item, items, "articles in series");
					}
					if(!replaying){
						gotoSeries.call(item, null, false, true);
					}
				}
				
				function showImage(att) {
					if (replaying && replaying != "selectArticle")
						return;
					domClass.remove(articleView.domNode, "text video");
					domClass.add(articleView.domNode, "image");
					domClass.remove(textView.domNode, "showArticleText");
					domClass.add(dom.byId("articleMessage"), "hidden");
					if (att) {
						setImageTitle(att.filename);
						loadImage(att.data);
					}
				}

				function showVideo(att) {
					if (replaying && replaying != "selectArticle")
						return;
					videoView.show();
					domClass.remove(articleView.domNode, "text image");
					domClass.add(articleView.domNode, "video");
					if (att) {
						setVideoTitle(att.filename);
						loadVideo(att.data, att.filename);
					}
				}

				function showText(body, text, att, type) {
					if (!body) {
						return;
					}
					if (replaying && replaying != "selectArticle")
						return;
					domClass.remove(articleView.domNode, "image video");
					domClass.add(articleView.domNode, "text");
					text = text || body.text;
					if (!text.match(/<\/\w*>/)) {
						text = "<pre>" + text + "</pre>";
					}
					if (att) {
						setArticleTitle(att.filename);
						type = type || "application/octet-stream";
						text += "<a href=\"" + makeDataUrl(att.data, type) + "\" type=\"" + type + "\" download>" + att.filename + "</a> ";
					}
					textView.scrollTo({
						x : 0,
						y : 0
					});
					dom.byId("from").innerHTML = body.from || "";
					dom.byId("date").innerHTML = body.date || "";
					dom.byId("newsgroups").innerHTML = body.newsgroups || "";
					dom.byId("textRect").innerHTML = text;
					progress();
				}

				showArticleText = function() {
					if (currentItem && currentItem.body) {
						domClass.add(textView.domNode, "showArticleText");
						showText(currentItem.body);
					}
				};

				showArticleBody = function() {
					if (currentItem && currentItem.body) {
						showBody(currentItem, currentItem.body);
					}
				};

				function setArticleTitle(s) {
					setImageTitle(s);
					textHeading.set("label", s);
				}

				function setImageTitle(s) {
					dom.byId("articleTitleLabel").innerHTML = s;
				}

				function setVideoTitle(s) {
					videoHeading.set("label", s);
				}

				function loadImage(data, partial) {
					articleImage.partial = partial;
					if(!data){
						articleImage.style.visibility = "hidden";
					}
					if (!setImageSrc(articleImage, data) && data) {
						fitImage();
					}
				}
				
				function setImageSrc(img, data) {
					return setSrc(img, makeDataUrl(data, "image/jpeg"));
				}
				
				function setSrc(obj, src) {
					var oldsrc = obj.getAttribute("src");
					if (src != oldsrc) {
						obj.setAttribute("src", src);
						freeDataUrl(oldsrc);
						return true;
					} else {
						return false;
					}
				}
				
				function loadVideo(data, name) {
					var p = name.split(".");
					var t = p.length >= 1 ? p[p.length - 1] : "mp4";
					setSrc(dom.byId("video"), makeDataUrl(data, "video/" + t));
					fitVideo();
				}

				function hideArticle() {
					domClass.remove(articleView.domNode, "image text video");
					articleImage.style.visibility = "hidden";
					domClass.add(dom.byId("articleMessage"), "hidden");
				}

				fitImage = function(resize, force) {

					var bg = dom.byId("imageBackground");
					var img = articleImage;

					if (!resize)
						progress();

					if (img.partial && !force && !resize) {
						if (img.invalid)
							img.invalid = false;
						else
							return;
					}

					var oldvis = img.style.visibility;
					img.style.visibility = "hidden";

					img.style.width = "auto";
					img.style.height = "auto";
					img.style.left = "0";
					img.style.top = "0";

					var vw = bg.offsetWidth;
					var vh = bg.offsetHeight;

					var iw = img.offsetWidth;
					var ih = img.offsetHeight;

					if (imageRealSized || (iw < vw && ih < vh)) {
						img.style.left = Math.max(0, (vw - iw) / 2) + "px";
						img.style.top = Math.max(0, (vh - ih) / 2) + "px";
					} else {
						centerImage(img, vw, vh, iw, ih);
						imageScroller.scrollTo({
							x : 0,
							y : 0
						});
						if(!slideshow)
							showArticleControls();
					}

					imageScroller.containerNode.style.width = Math.max(vw, iw)
							+ "px";
					imageScroller.containerNode.style.height = Math.max(vh, ih)
							+ "px";

					img.style.webkitTransform = "";

					if (imageRealSized) {
						imageScroller.scrollTo({
							x : Math.min(0, -(iw - vw) / 2),
							y : Math.min(0, -(ih - vh) / 2)
						});
					}

					img.style.visibility = resize ? oldvis : "inherit";
				}
				
				function centerImage(img, vw, vh, iw, ih) {
					iw = iw||img.offsetWidth;
					ih = ih||img.offsetHeight;
					if (ih / iw > vh / vw) {
						iw *= vh / ih;
						ih = vh;
						img.style.top = "0";
						img.style.left = ((vw - iw) / 2) + "px";
					} else {
						ih *= vw / iw;
						iw = vw;
						img.style.top = ((vh - ih) / 2) + "px";
						img.style.left = "0";
					}
					img.style.width = iw + "px";
					img.style.height = ih + "px";
				}

				fitVideo = function() {
					var bg = dom.byId("imageBackground");
					var img = dom.byId("video");

					var vw = bg.offsetWidth;
					var vh = bg.offsetHeight;

					var iw = 4 / 3;
					var ih = 1;

					if (ih / iw > vh / vw) {
						iw *= vh / ih;
						ih = vh;
						img.style.top = "0";
						img.style.left = ((vw - iw) / 2) + "px";
					} else {
						ih *= vw / iw;
						iw = vw;
						img.style.top = ((vh - ih) / 2) + "px";
						img.style.left = "0";
					}
					img.setAttribute("width", iw);
					img.setAttribute("height", ih);
				}

				imageError = function() {
					articleImage.style.visibility = "hidden";
					articleImage.invalid = true;
				}

				var lastX, lastY, controlsTimer;

				showArticleControls = function(e) {
					if (e) {
						if (Math.abs(e.pageX - lastX) < 4
								&& Math.abs(e.pageY - lastY) < 4)
							return;
						lastX = e.pageX;
						lastY = e.pageY;
					}
					domClass.remove(dom.byId("articleControls"), "hidden");
					hideArticleControls(5000);
				}

				function hideArticleControls(delay) {
					var c = dom.byId("articleControls");
					if (domClass.contains(c, "hidden"))
						return;
					if (controlsTimer)
						clearTimeout(controlsTimer);
					controlsTimer = setTimeout(function() {
						controlsTimer = null;
						domClass.add(c, "hidden");
					}, delay);
				}

				var prevNextTime = 0, slideshow = 0;
				var nextTimer;
				
				next = function(curItem, testOnly, bySlideshow) {
					if(!testOnly && !bySlideshow && startStopSlideshow(1)){
						return;
					}
					var item = (curItem||currentItem).nextItem;
					if (item && item.isMoreItem && !testOnly) {
						item.itemsLoaded = function() {
							item = (curItem||currentItem).nextItem;
							if (item) {
								showArticle(item);
								prevTouchTime = 0;
							}
						};
						nextTimer = setTimeout(function(){ item.onClick(); }, 200);
					
						return item;
					}
					if (item && !testOnly) {
						nextTimer = setTimeout(function(){ showArticle(item); }, 200);
						prevTouchTime = 0;
					}
					return item;
				};

				previous = function(curItem, testOnly, bySlideshow) {
					if(!testOnly && !bySlideshow && startStopSlideshow(-1)){
						return;
					}
					var item = (curItem || currentItem).prevItem;
					if (item && !testOnly) {
						nextTimer = setTimeout(function(){ showArticle(item); }, 200);
						prevTouchTime = 0;
					}
					return item;
				};

				function startStopSlideshow(dir) {
					// double-click/tap
					var now = new Date().getTime();
					var dt = now - prevNextTime;
					var arrowDir = dom.byId((dir>=0?"right":"left")+"ArrowDiv");
					var arrowOpp = dom.byId((dir<0?"right":"left")+"ArrowDiv");
					if (dir !== 0 && slideshow === 0 && dt < 300) {
						// start slide show
						if(nextTimer) clearTimeout(nextTimer);
						slideshow = dir;
						domClass.add(arrowDir, "slideshow");
						domClass.remove(arrowOpp, "slideshow");
						prevNextTime = 0;
						if(!currentRequest){
							doSlideshow();
						}
						return true;
					} else {
						if(slideshow !== 0) {
							// stop slide show
							if(slideshowTimer) clearTimeout(slideshowTimer);
							if(currentRequest){
								cancelRequest();
								if(slideshow > 0)
									previous(null, false, true);
								else
									next(null, false, true);
							}
							slideshow = 0;
							domClass.remove(arrowDir, "slideshow");
							domClass.remove(arrowOpp, "slideshow");
							return true;
						}
						prevNextTime = now;
					}
				}
				
				var slideshowTimer;
				
				function doSlideshow() {
					if(articleView.domNode.style.display === "none"){
						startStopSlideshow(0);
						return;
					}
					if(slideshow > 0){
						if(next(0, true)){
							if(slideshowTimer) clearTimeout(slideshowTimer);
							slideshowTimer = setTimeout(function(){
								next(null, false, true);
							}, settings.slideshowDelay||1000);
						} else {
							startStopSlideshow(0);
						}
					} else if(slideshow < 0){
						if(previous(0, true)){
							if(slideshowTimer) clearTimeout(slideshowTimer);
							slideshowTimer = setTimeout(function(){
								previous(null, false, true);
							}, settings.slideshowDelay||1000);
						} else {
							startStopSlideshow(0);
						}
					}
				}
				
				var prevTouchTime, cx, cy, dx0, dy0, imageScale, initialScale, initialScroll;

				function onImageTouchStart(e) {

					if (e.touches && e.touches.length == 2) {
						// 2 touch points: pinch to zoom/unzoom
						if (imageRealSized) {
							var x1 = e.touches[0].pageX, y1 = e.touches[0].pageY, x2 = e.touches[1].pageX, y2 = e.touches[1].pageY
							dx0 = Math.abs(x1 - x2);
							dy0 = Math.abs(y1 - y2);
							cx = (x1 + x2) / 2;
							cy = (y1 + y2) / 2;
							initialScale = imageScale;
							initialScroll = imageScroller.getPos();
							dom.byId("zoomDiv").style.visibility = "visible";
							event.stop(e);
						}
					} else {
						var now = new Date().getTime();
						var dt = now - prevTouchTime;
						if (dt <= 300) {
							// double-tap: toggle full screen
							realSize(!imageRealSized);
							prevTouchTime = 0;
						} else {
							prevTouchTime = now;
						}
						prevTouches = null;
					}
				}

				function realSize(real) {
					imageRealSized = real;

					if (imageRealSized) {
						imageScale = 1;
						dom.byId("zoomDiv").innerHTML = "x1";
						setTimeout(hideArticleControls, 200);
					}

					imageScroller.mouseWheelScrollModifier = imageRealSized ? "shiftKey"
							: null;

					imageScroller.scrollDir = imageRealSized ? "vh" : "h";
					imageScroller._v = imageRealSized;

					fitImage(false, true);
				}

				function onImageTouchMove(e) {
					if (e.touches && e.touches.length == 2) {
						// 2 touch points: pinch to zoom/unzoom
						if (imageRealSized) {
							// compute new scale factor
							var x1 = e.touches[0].pageX, y1 = e.touches[0].pageY, x2 = e.touches[1].pageX, y2 = e.touches[1].pageY
							var dx = Math.abs(x1 - x2);
							var dy = Math.abs(y1 - y2);
							var s = dx > dy ? dx / dx0 : dy / dy0;

							zoomImage(s, cx, cy, initialScale, initialScroll);

							// prevent panning
							event.stop(e);
						}
					}
				}

				function onImageTouchEnd(e) {
					dom.byId("zoomDiv").style.visibility = "hidden";
				}

				function onImageWheel(e) {
					if (imageRealSized && !e.shiftKey) {
						var delta = has("ff") ? -e.detail : e.wheelDelta;
						zoomImage(delta > 0 ? 1.5 : 0.75, e.pageX, e.pageY,
								imageScale, imageScroller.getPos());
						event.stop(e);
					}
				}

				function zoomImage(s, cx, cy, initialScale, initialScroll) {

					imageScale = initialScale * s;

					var img = articleImage;

					// resize scrollable view container
					var bg = dom.byId("imageBackground");
					var vw = bg.offsetWidth;
					var vh = bg.offsetHeight;
					var iw = img.offsetWidth * imageScale;
					var ih = img.offsetHeight * imageScale;
					imageScroller.containerNode.style.width = Math.max(vw, iw)
							+ "px";
					imageScroller.containerNode.style.height = Math.max(vh, ih)
							+ "px";

					// apply new scale transform
					img.style.webkitTransform = "scale3d(" + imageScale + ","
							+ imageScale + ",1)";

					// set scroll position so image stays centers
					// at the middle point of the two fingers
					var r = (imageScale / initialScale - 1);
					var p = initialScroll;
					imageScroller.scrollTo({
						x : p.x - (cx - p.x) * r,
						y : p.y - (cy - p.y) * r,
					}, true);
					imageScroller._locked = true;

					// display new scale
					dom.byId("zoomDiv").innerHTML = "x"
							+ Math.round(imageScale * 100) / 100;
				}

				resize = function() {
					fitImage(true);
					fitVideo();
					resizeThumbnails();
				}

				//---------- Image index ----------

				var thumbnailColWidth, thumbnailMargin = 6, thumbnailNameHeight = 10;
				var indexParent, thumbnailClicked, down = true, pauseClicked;

				function initThumbnails() {
					indexParent = dom.byId("indexParent");

					computeThumbnailColWidth();
				}

				function computeThumbnailColWidth() {
					var w = mobile.getScreenSize().w;
					var cols = Math.floor(w
							/ (settings.thumbnailSize + 2 * thumbnailMargin));
					cols = Math.max(cols, 2);
					thumbnailColWidth = Math.floor((w / cols) - 2
							* thumbnailMargin);
				}

				var currentThumbnailItem, currentThumbnailParent;
				var currentItemBeforeThumbails;

				showThumbnails = function() {
					record("showThumbnails", null, []);
					currentItemBeforeThumbails = currentItem;
					articleView.performTransition("index", 1,
							replaying ? "none" : "slide");
					if (replaying) {
						stopThumbnails();
					} else if (!pauseClicked) {
						getThumbnail(currentItem);
					}
					resize(); // ???
				};

				pauseResumeThumbnails = function() {
					if (pauseButton.get("label") == "Pause") {
						pauseClicked = true;
						stopThumbnails();
					} else {
						pauseClicked = false;
						getThumbnail(currentThumbnailItem || currentItem);
					}
				};

				toggleThumbnailsDir = function() {
					record("toggleThumbnailsDir", null, []);
					down = !down;
					upDownButton.set("label", down ? "▲" : "▼");
				};

				clearThumbnails = function() {
					clearRecords("addThumbnails");
					var thp;
					while ((thp = indexParent.firstChild) && thp.item) {
						thp.item.thumbnailBody = null;
						indexParent.removeChild(thp);
					}
					domClass.add(clearButton.domNode, "disabled");
				};

				leaveIndexView = function() {
					clearRecords("showThumbnails");
					stopThumbnails();
					var item = currentItemBeforeThumbails || currentItem;
					currentItemBeforeThumbails = null;
					if (!thumbnailClicked && item) {
						showArticle(item);
					}
					thumbnailClicked = false;
				};

				function stopThumbnails() {
					cancelRequest();
					pauseButton.set("label", "Resume");
					progress();
					removeThumbnailParent();
				}

				function removeThumbnailParent() {
					if (currentThumbnailParent) {
						if (currentThumbnailParent.parentNode == indexParent) {
							indexParent.removeChild(currentThumbnailParent);
						}
						currentThumbnailParent = null;
					}
				}

				function getThumbnail(item, next) {

					var prev;
					while (item && (next || item.thumbnailBody)) {
						next = false;
						prev = item;
						item = window[down ? "next" : "previous"](item, true);
					}

					if (!item) {
						pauseButton.set("label", "Resume");
						return;
					}

					pauseButton.set("label", "Pause");

					var thp = createThumbnailParent();
					var th;

					currentThumbnailParent = thp;

					var loadThumbnail = function(item) {

						currentThumbnailItem = item;

						var args = {
							articleId : item.articleId,
							size : settings.thumbnailSize
						};

						if (settings.async) {
							var f = function(id) {
								currentAsyncId = null;
								doRequest("p", {
									id : id
								}, null, function(result) {
									var p = result.progress;
									p.complete = p.complete == "true";

									if (p.filename) {
										setThumbnailName(thp, p.filename);
									}
									if (p.chunk) {
										if (!th) {
											th = createThumbnail(p.chunk, item,
													thp);
										} else {
											setImageSrc(th, p.chunk);
										}
									}

									if (!p.complete) {
										f(id);
									} else {
										currentAsyncId = null;
										currentThumbnailItem = null;
										currentThumbnailParent = null;
										progress();
										if (p.exception) {
											thp.innerText = p.exception;
											showError(p.exception);
										} else {
											if (p.body) {
												addThumbnails(p.body, item,
														thp, th);
											}
										}
									}
								}, function(err) {
									removeThumbnailParent();
									if (err.dojoType != "cancel") {
										progress();
										showError(err);
									}
								});
								currentAsyncId = id;
							};
							progress(thp);
							doRequest("tha", args, null, f);
						} else {
							doRequest("th", args, thp, function(result) {
								addThumbnails(result.articleBody, item, thp);
							});
						}
					}

					if (!item.isMoreItem) {
						loadThumbnail(item);
					} else if (prev) {
						progress(thp);
						item.itemsLoaded = function() {
							loadThumbnail(prev.nextItem);
						}
						item.onClick();
					}
				}

				function addThumbnails(body, item, thp, th) {
					record("addThumbnails", null, [ body, item ]);
					array.forEach(ensureArray(body.attachments), function(att) {

						if (!thp) {
							thp = createThumbnailParent();
						}

						setThumbnailName(thp, att.filename);

						if (!th) {
							th = createThumbnail(att.data, item, thp);
						} else {
							setImageSrc(th, att.data);
						}

						item.thumbnailBody = body;
						thp.item = item;

						thp = null;
						th = null;
					});

					domClass.remove(clearButton.domNode, "disabled");

					if (!replaying)
						getThumbnail(item, true);
				}

				function createThumbnailParent() {
					var thp = document.createElement("div");
					domClass.add(thp, "indexThumbnailParent");
					var m = thumbnailMargin + "px";
					thp.style.margin = m + " " + m + " "
							+ (2 * thumbnailMargin + thumbnailNameHeight * 2)
							+ "px" + " " + m;
					var sz = thumbnailColWidth + "px";
					var thsz = settings.thumbnailSize + "px";
					thp.style.width = sz;
					thp.style.height = thsz;
					thp.style.lineHeight = thsz;
					var t = document.createElement("div");
					domClass.add(t, "indexThumbnailName");
					t.style.height = thumbnailNameHeight + "px";
					t.style.lineHeight = thumbnailNameHeight + "px";
					t.style.top = (settings.thumbnailSize + thumbnailMargin)
							+ "px";
					thp.appendChild(t);
					thp.nameDiv = t;
					indexParent.appendChild(thp);
					return thp;
				}

				function setThumbnailName(thp, name) {
					thp.nameDiv.innerText = name;
				}

				function createThumbnail(data, item, thp) {
					var th = document.createElement("img");
					domClass.add(th, "indexThumbnail");
					var sz = thumbnailColWidth + "px";
					th.style.maxWidth = sz;
					th.style.maxHeight = sz;
					setImageSrc(th, data);
					on(th, "click", function() {
						thumbnailClicked = true;
						indexView.performTransition("article", -1, "slide");
						showArticle(item);
					});
					thp.appendChild(th);
					thp.th = th;
					return th;
				}

				function resizeThumbnails() {
					computeThumbnailColWidth();

					var sz = thumbnailColWidth + "px";
					var thsz = settings.thumbnailSize + "px";
					array
							.forEach(
									indexParent.childNodes,
									function(thp) {
										thp.style.width = sz;
										thp.style.height = thsz;
										thp.style.lineHeight = thsz;
										var th = thp.th;
										if (th) {
											th.style.maxWidth = sz;
											th.style.maxHeight = sz;
										}
										var t = thp.nameDiv;
										if (t) {
											t.style.top = (settings.thumbnailSize + thumbnailMargin)
													+ "px";
										}
									});
				}

				//---------- Utility methods ----------

				var currentServer, currentRequest, currentUnrar;

				function buildServerString(server) {
					server = server || currentServer;
					var s = server.hostname;
					if (server.username) {
						if (server.password)
							s = server.username + ":" + server.password + "@"
									+ s;
						else
							s = server.username + "@" + s;
					}
					if (server.port) {
						s += ":" + server.port;
					}
					return s;
				}

				function progress(parent) {
					var prog = Progressindicator.getInstance();
					prog.stop();
					if (parent) {
						prog.domNode.style.top = "50%";
						prog.domNode.style.marginTop = "-20px";
						prog.domNode.style.visibility = "visible";
						(parent.domNode || parent).appendChild(prog.domNode);
						prog.start();
					}
				}

				function decodeBinaryResponse(response){
					response = Uint8ArrayToBinary(new Uint8Array(response));
					var parts = response.split("\n--simple boundary");
					var result;
					for(var i = 0; i < parts.length; i++){
						var p = parts[i];
						var m = p.match(/^\nContent-Type: application\/([\w-_]*)\n\n/);
						if(m){
							var t = p.substring(m[0].length);
							switch(m[1]){
							case "json":
								result = json.parse(t);
								break;
							case "octet-stream":
								if (result) {
									var body;
									if (result.progress) {
										if(result.progress.hasChunk === "true" && !result.progress.chunk){
											result.progress.chunk = t;
										} else {
											body = result.progress.body;
										}
									} else{
										body = result.articleBody;
									}
									if (body && body.attachments) {
										var atts = ensureArray(body.attachments);
										for (var j = 0; j < atts.length; j++) {
											var att = atts[j];
											if (att && !att.data) {
												att.data = t;
												break;
											}
										}
									}
								}
								break;
							}
						}
					}
					return result;
				}

				function doRequest(command, args, progressParent, success,
						error, server) {

					if (replayResult) {
						var result = replayResult;
						replayResult = null;
						success(result);
						return;
					}

					if (progressParent && !(slideshow !== 0 && !settings.async))
						progress(progressParent);

					cancelRequest();

					var url = serviceUrl + command;

					var data = args || {};
					data.host = buildServerString(server);

					var handleAs;
					switch (command) {
					case "t":
					case "ba":
					case "tha":
						handleAs = "text";
						break;
					case "p":
					case "b":
					case "th":
						handleAs = "arraybuffer"
						break;
					default:
						handleAs = "json";
						break;
					}

					currentRequest = request.post(
							url,
							{
								data : data,
								preventCache : command == "t"
										|| command == "ba" || command == "tha"
										|| command == "p",
								handleAs : handleAs
							}).then(function(response) {
						if (handleAs === "arraybuffer") {
							response = decodeBinaryResponse(response);
						}
						currentRequest = null;
						if (progressParent)
							progress();
						success(response);
					}, function(err) {
						currentRequest = null;
						if (error) {
							error(err);
						} else {
							if (err.dojoType != "cancel") {
								if (progressParent)
									progress();
								showError(err);
							}
						}
					});
				}

				cancelRequest = function() {
					if (currentRequest) {
						currentRequest.cancel();
						currentRequest = null;
						prevTouchTime = 0;
					}
					if (currentUnrar) {
						currentUnrar.cancel();
						currentUnrar = null;
					}
					if (currentAsyncId) {
						request.post(serviceUrl + "c", {
							data : {
								id : currentAsyncId
							},
							preventCache : true,
							handleAs : "text"
						});
						currentAsyncId = null;
					}
				}

				function showMessage(s) {
					if (replaying)
						return;
					if (articleView.domNode.style.display != "none") {
						domClass.remove(dom.byId("articleMessage"), "hidden");
						dom.byId("articleMessageText").innerHTML = s;
					} else {
						msgDialog.show();
						dom.byId("msgText").innerHTML = s;
					}
				}

				function showError(error, defaultMessage) {
					showMessage(makeErrorMessage(error, defaultMessage));
					if (currentItem && currentItem.domNode) {
						domClass.add(currentItem.domNode, "error");
					}

					doSlideshow();
				}

				function makeErrorMessage(error, defaultMessage) {
					var m = error.responseText
							|| (error.response && 
									(error.response.text ||
											(error.response.data instanceof ArrayBuffer &&
													Uint8ArrayToBinary(new Uint8Array(error.response.data)))));
					if (m) {
						var i = m.indexOf(' ');
						if (i > 0) {
							var code = m.substring(0, i);
							if (code >= 100 && code < 600) {
								m = m.substring(i + 1);
								if (code == 501)
									m = "Syntax error: " + m;
								return m;
							}
						}
						i = m.indexOf("<h1>");
						if (i > 0) {
							return m.substring(i + 4, m.indexOf("</h1>"));
						}
					}
					if (error.message && error.message.match(/Unable to load/)) {
						return "Server error, try again later.";
					}
					return defaultMessage || error.message || error;
				}

				function clearList(list) {
					var children;
					while ((children = list.getChildren()).length > 0) {
						var child = children[0];
						list.removeChild(child);
						if (child._groupItems) {
							array.forEach(child._groupItems, function(it) {
								it.destroyRecursive();
								if (it == currentItem) {
									currentItem = null;
								}
							});
						}
						child.destroyRecursive();
						if (child == currentItem) {
							currentItem = null;
						}
					}
					var v = viewRegistry.getEnclosingScrollable(list.domNode);
					if (v) {
						v.autoLoadItem = null;
					}
					clearThumbnails();
				}

				function suffix(name) {
					var p = name.toLowerCase().split(".");
					return p[p.length - 1];
				}

				//---------- Binary data conversion ----------

				function binaryToUint8Array(binary) {
					if (binary instanceof Uint8Array) {
						return binary;
					}
					var len = binary.length;
					var bytes = new Uint8Array(len);
					for ( var i = 0; i < len; i++) {
						var ascii = binary.charCodeAt(i);
						bytes[i] = ascii;
					}
					return bytes;
				}

				/* using blobs
				function makeDataUrl(data, type) {
					if (data && !(data instanceof Uint8Array)) {
						data = binaryToUint8Array(data);
					}
					return URL.createObjectURL(new Blob([ data ], { type : type }));
				}
				
				function freeDataUrl(url) {
					URL.revokeObjectURL(url);
				}
				*/

				/* using base64 */
				function makeDataUrl(data, type) {
					if (data && data instanceof Uint8Array) {
						data = Uint8ArrayToBinary(data);
					}
					return "data:" + type + ";base64," + btoa(data);
				}
				
				function freeDataUrl(url) {
				}
				
				function makeImageUrl(data) {
					return makeDataUrl(data, "image/jpeg");
				}
				
				var blockSize = 10000;

				function Uint8ArrayToBinary(bytes) {
					if (!(bytes instanceof Uint8Array)) {
						return bytes;
					}
					var binary = '';
					var len = bytes.byteLength;
					for ( var start = 0; start < len; start += blockSize) {
						binary += String.fromCharCode.apply(null, bytes
								.subarray(start, start + blockSize));
					}
					return binary;
				}

				//---------- Mouse wheel scrolling & auto-loading----------

				var oldBuildRendering = ScrollableView.prototype.buildRendering;
				ScrollableView
						.extend({
							buildRendering : function() {
								oldBuildRendering.call(this);
								var v = this;
								v.on(has("ff") ? "DOMMouseScroll"
										: "mousewheel", function(e) {
									if (v.mouseWheelScrollModifier
											&& !e[v.mouseWheelScrollModifier]) {
										return;
									}
									scroll(v, (has("ff") ? -e.detail
											: e.wheelDelta) > 0 ? 1 : -1);
								});
								var autoLoad = function(to) {
									if (!currentRequest && !replaying) {
										var item = v.autoLoadItem;
										if (item && item.getParent()) {
											var rect = item.domNode
													.getBoundingClientRect();
											if (rect.top >= 0
													&& rect.left >= 0
													&& rect.bottom <= (window.innerHeight || document.documentElement.clientHeight)
													&& rect.right <= (window.innerWidth || document.documentElement.clientWidth)) {
												item.onClick();
											}
										}
									}
									if (v == searchView || v == newsgroupView || v == seriesView || v == seriesView2) {
										var f = v.id.replace(/2$/, "") + "Scroll";
										clearRecords(f);
										record(f, null, [ to.y ]);
									}
								}
								aspect.after(v, "scrollTo", autoLoad, true);
								aspect.after(v, "slideTo", autoLoad, true);
							}
						});

				function scroll(v, delta) {
					var d = v.getDim();
					var p = v.getPos();
					var y = p.y;
					y += delta * d.d.h;
					if (y < d.d.h - d.c.h) {
						y = d.d.h - d.c.h;
					}
					if (y > 0) {
						y = 0;
					}
					v.flashScrollBar();
					v.scrollTo({
						x : p.x,
						y : y
					});
				}

				//---------- Settings ----------

				var connectEnabled, autoName, editedServer;

				var settingsInited;

				function initSettings() {

					// Read settings from local storage

					var settingsAsJSON = localStorage.settings;

					if (settingsAsJSON) {
						settings = json.parse(settingsAsJSON);
					} else {
						settings = {};
					}
					settings = lang.mixin(lang.mixin({}, defaultSettings),
							settings);

					// Init settings view

					array.forEach(settings.servers, addServerItem);
					if (settings.currentServer >= 0
							&& settings.currentServer < settings.servers.length) {
						setCurrentServer(settings.servers[settings.currentServer]);
					} else {
						registry.byId("settings").show();
					}

					browseSwitch.set("value", settings.browse ? "on" : "off");
					filterBox.set("value", settings.searchFilter);
					resultsCountBox.set("value", settings.searchResultsCount);
					getHeadersTimeoutBox.set("value",
							settings.getHeadersTimeout);
					dom.byId("searchEngineSelect").value = settings.searchEngine;
					updateDisplayedEngine();

					updateSearchControls();

					asyncSwitch.set("value", settings.async ? "on" : "off");
					progressSwitch.set("value", settings.progress ? "on"
							: "off");
					partialSwitch.set("value", settings.partial ? "on" : "off");
					optimizeImageDownloadSwitch.set("value",
							settings.optimizeImageDownload ? "on" : "off");

					updateLoadingSettingsItems();

					stateSwitch.set("value", settings.state ? "on" : "off");

					thumbnailSizeBox.set("value", settings.thumbnailSize);
					listThumbnailsSwitch.set("value", settings.listThumbnails ? "on" : "off");

					slideshowDelayBox.set("value", settings.slideshowDelay);

					settingsInited = true;
				}

				updateSearchSettings = function() {

					if (!settingsInited)
						return;

					settings.browse = browseSwitch.get("value") == "on";
					settings.searchFilter = filterBox.get("value");
					settings.searchResultsCount = parseInt(resultsCountBox
							.get("value"));
					settings.getHeadersTimeout = parseInt(getHeadersTimeoutBox
							.get("value"));
					settings.searchEngine = dom.byId("searchEngineSelect").value;
					updateDisplayedEngine();

					localStorage.settings = json.stringify(settings);

					updateSearchControls();
				};

				function updateDisplayedEngine() {
					var select = dom.byId("searchEngineSelect");
					for ( var i = 0; i < select.options.length; i++) {
						var o = select.options[i];
						if (o.selected) {
							dom.byId("searchEngineDiv").innerText = o.text;
						}
					}
				}

				updateSearchControls = function() {
					disable(filterBox, settings.browse);
					disable(searchEngineSelect, settings.browse);
					searchBox.set("placeholder", settings.browse ? "newsgroups"
							: "articles");
				};

				updateLoadSettings = function() {
					if (!settingsInited)
						return;

					settings.async = asyncSwitch.get("value") == "on";
					settings.progress = progressSwitch.get("value") == "on";
					settings.partial = partialSwitch.get("value") == "on";
					settings.optimizeImageDownload = optimizeImageDownloadSwitch
							.get("value") == "on";

					updateLoadingSettingsItems();

					localStorage.settings = json.stringify(settings);
				};

				updateStateSettings = function() {
					if (!settingsInited)
						return;

					settings.state = stateSwitch.get("value") == "on";

					localStorage.settings = json.stringify(settings);
				};

				updateThumbnailsSettings = function() {
					if (!settingsInited)
						return;

					settings.thumbnailSize = parseInt(thumbnailSizeBox
							.get("value"));
					settings.listThumbnails = listThumbnailsSwitch.get("value") == "on";

					localStorage.settings = json.stringify(settings);

					resizeThumbnails();
				};

				updateSlideshowSettings = function() {
					if (!settingsInited)
						return;

					settings.slideshowDelay = parseInt(slideshowDelayBox
							.get("value"));

					localStorage.settings = json.stringify(settings);

					resizeThumbnails();
				};

				function disable(w, disable) {
					domClass[disable ? "add" : "remove"](w.parentNode
							|| w.getParent().domNode, "disabled");
				}

				function updateLoadingSettingsItems() {
					disable(progressSwitch, !settings.async);
					disable(partialSwitch, !settings.async);
					disable(optimizeImageDownloadSwitch, settings.async);
				}

				function addServerItem(server) {
					var item = new ListItem({
						_server : server,
						label : server.name,
						rightIcon : "mblDomButtonBlueInfo",
						clickable : true,
						noArrow : true,
						onClick : function(e) {
							var server = item._server;
							for ( var t = e.target; t; t = t.parentNode) {
								if (domClass
										.contains(t, "mblDomButtonBlueInfo")) {
									editServer(server);
									return;
								}
							}
							testServer(server, item, function() {
								setCurrentServer(server);
							});
						},
						_duration : 200
					});
					serverList.addChild(item,
							serverList.getChildren().length - 1);
					return item;
				}

				editServer = function(server) {
					editedServer = server.hostname ? server : null;

					deleteServerButton.domNode.style.visibility = (editedServer && settings.servers.length > 1) ? "visible"
							: "hidden";

					nameBox.set("value", server.name || "");
					hostnameBox.set("value", server.hostname || "");
					portBox.set("value", server.port || "");
					usernameBox.set("value", server.username || "");
					passwordBox.set("value", server.password || "");
					retentionBox.set("value", server.retention || "");
					replyItem.set("label", server.reply || "");

					settingsView.performTransition("server", 1, "slide");
				}

				function enableConnectButton(enable) {
					connectEnabled = enable;
					var f = domClass[enable ? "remove" : "add"];
					f(connectButton.domNode, "disabled");
					f(okButton.domNode, "disabled");
				}

				connect = function() {
					if (!connectEnabled) {
						return;
					}

					var server = {
						name : nameBox.get("value"),
						hostname : hostnameBox.get("value"),
						port : parseInt(portBox.get("value") || "0"),
						username : usernameBox.get("value"),
						password : passwordBox.get("value"),
						retention : parseInt(retentionBox.get("value") || "0")
					};

					var updateServer = function(server) {
						var index;
						if (editedServer) {
							index = getServerIndex(editedServer);
							settings.servers[index] = server;
							var item = serverList.getChildren()[index];
							item._server = server;
							item.set("label", server.name);
						} else {
							index = settings.servers.length;
							settings.servers.push(server);
							addServerItem(server);
						}

						serverView.performTransition("settings", -1, "slide");
					};

					if (this == connectButton) {
						testServer(server, serverView, function(s) {
							replyItem.set("label", s);
							updateServer(server);
							setCurrentServer(server);
						}, function(s) {
							replyItem.set("label", s);
						});
					} else {
						updateServer(server);
					}
				};

				function getServerIndex(server) {
					var index = -1;
					array.forEach(settings.servers, function(s, i) {
						if (s.name == server.name) {
							index = i;
						}
					});
					return index;
				}

				function testServer(server, progressParent, success, error) {
					doRequest("t", null, progressParent, function(s) {
						server.reply = s;
						success(s);
					}, function(err) {
						progress();
						server.reply = makeErrorMessage(err);
						if (error) {
							error(err);
						}
						if (err.dojoType != "cancel") {
							showError(err);
						}
					}, server);
				}

				deleteServer = function() {
					if (editedServer && settings.servers.length > 1) {

						serverView.performTransition("settings", -1, "slide");

						var index = getServerIndex(editedServer);
						var newIndex = index == 0 ? 1 : 0;
						var newItem = serverList.getChildren()[newIndex];
						var newServer = settings.servers[newIndex];
						serverList.removeChild(serverList.getChildren()[index]);
						settings.servers.splice(index, 1);
						setCurrentServer(newServer);
						localStorage.settings = json.stringify(settings);
					}
				}

				function setCurrentServer(server) {

					currentServer = server;

					settings.currentServer = getServerIndex(server);
					localStorage.settings = json.stringify(settings);

					array
							.forEach(
									serverList.getChildren(),
									function(item) {
										item
												.set(
														"icon",
														item._server == server ? "mblDomButtonDarkBlueCheck"
																: "mblDomButtonTransparent20");
									});
				}

				nameBoxChanged = function() {
					var name = nameBox.get("value");
					var addr = hostnameBox.get("value");
					autoName = name == addr;
				};

				hostnameBoxChanged = function() {
					enableConnectButton(hostnameBox.get("value").split(".").length >= 3);
					if (nameBox.get("value").length == 0 || autoName) {
						nameBox.set("value", hostnameBox.get("value"));
					}
				};

				//---------- Current state ----------

				var funcnames = [ "setSearch", "getNewsgroups",
						"selectNewsgroup", "getArticles",
						"searchScroll", "newsgroupScroll", "seriesScroll",
						"getBody", "gotoSeries", "selectArticle", "addThumbnails",
						"toggleThumbnailsDir", "showThumbnails" ];

				function SQLStorage() {
					this.name = "WebSQL";
					this.db = openDatabase('NI', '1.0', 'App state storage DB',
							50 * 1024 * 1024);
					this.db
							.transaction(lang
									.hitch(
											this,
											function(tx) {
												tx
														.executeSql(
																'CREATE TABLE IF NOT EXISTS STATE (i INTEGER PRIMARY KEY AUTOINCREMENT, f, r)',
																null,
																null);
											}));
					this.record = function(f, r) {
						this._convertBody(r, true);
						var jr = json.stringify(r);
						this.db.transaction(lang.hitch(this, function(tx) {
							tx.executeSql(
									'INSERT INTO STATE (f, r) VALUES (?, ?)', [f, jr]);
						}));
					};
					this.load = function(cb) {
						var state = {};
						array.forEach(funcnames, function(f) {
							state[f] = [];
						});
						this.db
								.transaction(lang
										.hitch(
												this,
												function(tx) {
													tx
															.executeSql(
																	'SELECT * FROM STATE ORDER BY i',
																	null,
																	lang.hitch(this, function(
																			tx,
																			results) {
																		for ( var i = 0; i < results.rows.length; i++) {
																			var row = results.rows.item(i);
																			if (state[row.f]) {
																				var pr = json.parse(row.r);
																				this._convertBody(pr, false);
																				state[row.f].push(pr);
																			}
																		}
																		cb(state);
																	}));
												}));
					};
					this.clear = function(f) {
						this.db.transaction(lang.hitch(this, function(tx) {
							if (f) {
								tx.executeSql('DELETE FROM STATE WHERE f=?',
										[ f ]);
							} else {
								tx.executeSql('DELETE FROM STATE');
							}
						}));
					};
					
					this._convertBody = function(r, record) {
						if(!r || !r.r)
							return;
						var body = r.r.articleBody;
						if(!body)
							return;
						r.r.articleBody = {
							from : body.from,
							date : body.date,
							newsgroups : body.newsgroups,
							text : body.text,
							articles: body.articles,
							attachments : array
									.map(
											ensureArray(body.attachments),
											function(att) {
												return {
													filename : att.filename,
													data : record ? btoa(Uint8ArrayToBinary(att.data)) : atob(att.data)
												};
											})
						};
					};
				}
				
				function IndexedDBStorage() {
					this.name = "IndexedDB";
					this._db = function(f, mode){
						var _call = function(db){
							var store = db.transaction("states", "readwrite").objectStore("states");
							var req = f(store);
							if(req){
								req.onerror = function(evt){
									console.log(req + " error");
								};
							}
						};
						if(!this.db){
							var request = indexedDB.open("NI", 2);
							request.onsuccess = lang.hitch(this, function(event){
								this.db = event.target.result;
								_call(this.db);
							});
							request.onupgradeneeded = lang.hitch(this, function(event){
								this.db = event.target.result;
								var store = this.db.createObjectStore("states", { autoIncrement: true });
								store.createIndex("f", "f", { unique: false });
							});
						} else {
							_call(this.db);
						}
					}
					this.record = lang.hitch(this, function(f, r) {
						this._db(function(store){
							return store.add(r);
						});
					});
					this.load = function(cb) {
						this._db(function(store){
							var state = {};
							array.forEach(funcnames, function(f) {
								state[f] = [];
							});
							store.openCursor().onsuccess = function(event){
							  var cursor = event.target.result;
							  if (cursor) {
								var r = cursor.value;
								if (state[r.f]) {
									state[r.f].push(r);
								}
							  	cursor.continue();
							  } else {
								  cb(state);
							  }
							};
						});
					};
					this.clear = function(f) {
						this._db(function(store){
							if(f){
								store.index("f").openKeyCursor(IDBKeyRange.only(f)).onsuccess = function(event){
								  var cursor = event.target.result;
								  if (cursor) {
									store.delete(cursor.primaryKey);
								  	cursor.continue();
								  }
								};
							} else {
								store.clear();
							}
						});
					};
				}

				var storage;

				function createStorage() {
					if (!storage){
						if(typeof indexedDB !== "undefined")
							storage = new IndexedDBStorage();
						else
							storage = new SQLStorage();
						dom.byId("stateUsing").innerHTML = storage.name;
					}
				}
				
				function record(f, t, a, r) {
					if (replaying || !settings.state)
						return;
					var i;
					var na = [];
					for (i = 0; i < a.length; i++) {
						var v = a[i];
						na[i] = (v.domNode && v.id) ? ("_widget_" + v.id) : v;
					}
					if (t) {
						t = t.id;
					}
					try {
						storage.record(f, {
							f : f,
							t : t,
							a : na,
							r : r
						});
					} catch (err) {
					}
				}

				function clearRecords(f) {
					if (replaying || !settings.state)
						return;
					storage.clear(f);
				}

				function clearLastRecord(f) {
					if (replaying || !settings.state)
						return;
					storage.load(function(state) {
						var s = state[f];
						clearRecords(f);
						for(var i = 0; i < s.length-1; i++){
							storage.record(f, s[i]);
						}
						replaying = null;
						domClass.remove(document.documentElement, "replaying");
						dom.byId("loadingScreen").style.display = "none";
					});
				}

				var replaying, replayResult;

				function replay(r) {
					replaying = r.f;
					domClass.add(document.documentElement, "replaying");
					var i;
					var a = r.a;
					for (i = 0; i < a.length; i++) {
						var v = a[i];
						if (typeof v == "string" && v.match(/^_widget_(.*)/)) {
							a[i] = registry.byId(RegExp.$1);
						}
					}
					if (r.t) {
						r.t = registry.byId(r.t);
					}
					var f = funcs[r.f];
					replayResult = r.r;
					f.apply(r.t, a);
				}

				function setSearch(value) {
					searchBox.set("value", value);
				}

				function searchScroll(y) {
					searchView.scrollTo({
						y : y
					});
				}

				function newsgroupScroll(y) {
					newsgroupView.scrollTo({
						y : y
					});
				}

				function seriesScroll(y) {
					var view = (seriesView.domNode.style.display != "none" ? seriesView : seriesView2);
					view.scrollTo({
						y : y
					});
				}

				var funcs = {
					setSearch : setSearch,
					getNewsgroups : getNewsgroups,
					selectNewsgroup : selectNewsgroup,
					getArticles : getArticles,
					gotoSeries : gotoSeries,
					searchScroll : searchScroll,
					newsgroupScroll : newsgroupScroll,
					seriesScroll : seriesScroll,
					getBody : getBody,
					selectArticle : selectArticle,
					addThumbnails : addThumbnails,
					toggleThumbnailsDir : toggleThumbnailsDir,
					showThumbnails : showThumbnails
				};

				function restoreState() {
					storage.load(function(state) {
						array.forEach(funcnames, function(f) {
							array.forEach(state[f], function(r) {
								try {
									replay(r);
								} catch (err) {
									console.log("error replaying " + f + " : "
											+ err);
								}
							});
						});
						replaying = null;
						domClass.remove(document.documentElement, "replaying");
						dom.byId("loadingScreen").style.display = "none";
					});
				}

				function clearState() {
					if (replaying)
						return;
					storage.clear();
				}
				
				function initState() {
					createStorage();
					if (settings.state) {
						restoreState();
					} else {
						clearState();
						dom.byId("loadingScreen").style.display = "none";
					}
				}
			});
</script>

<style type="text/css">
body,html {
	height: 100%;
}

#loadingScreen {
	position: absolute;
	z-index: 9999;
	left: 0;
	top: 0;
	right: 0;
	bottom: 0;
	height: 100%;
	background: white;
}

.mblEdgeToEdgeList .mblListItem {
	font-size: 11pt;
}

.mblEdgeToEdgeList .mblListItem.read {
	color: #909090;
}

.mblEdgeToEdgeList .mblListItem.error {
	color: #e0a090;
}

.mblEdgeToEdgeList {
	border: none;
}

.mblToolBarButton {
	font-size: 18px;
	font-weight: normal;
}

.searchHeading {
	height: 44px;
	border-bottom: none;
	background-color: #c0c0c0;
}

.searchBoxParent {
	position: absolute;
	top: 6px;
	left: 6px;
	right: 66px;
}

.searchIcon {
	position: absolute;
	left: 7px;
	top: 11px;
}

.searchBox {
	position: absolute;
	top: 2px;
	left: 0;
	width: 100%;
	border: none;
	height: 20px;
	padding-left: 27px;
	padding-right: 7px;
	padding-top: 4px;
	padding-bottom: 4px;
	border-radius: 6px;
}

.dj_iphone .searchBox {
	padding-top: 2px;
	height: 22px;
}

.clearIcon {
	visibility: hidden;
	position: absolute;
	right: 37px;
	top: 13px;
	border-radius: 10px;
	width: 18px;
	height: 18px;
	background-color: #c0c0c0;
}

.clearIcon div {
	position: absolute;
	left: 3px;
	top: 8px;
	background-color: white;
	width: 12px;
	height: 2px;
	-webkit-transform-origin: 50% 50%;
	transform-origin: 50% 50%;
}

.clearIconDiv1 {
	-webkit-transform: rotate(45deg);
	transform: rotate(45deg);
}

.clearIconDiv2 {
	-webkit-transform: rotate(-45deg);
	transform: rotate(-45deg);
}

.settingsButton {
	position: absolute;
	top: 3px;
	right: 0px;
	width: 24px;
	height: 24px;
	padding: 0;
	background: rgba(255, 255, 255, 0.1);
	pointer-events: all !important;
}

.invisibleButton {
	position: absolute;
	top: -1000px;
	left: -1000px;
	width: 0;
	height: 0;
}

.settingsButton>div {
	position: absolute;
	width: 16px;
	left: 6px;
	background-color: #606060;
	height: 2px;
}

.settingsButtonL1 {
	top: 6px;
}

.settingsButtonL2 {
	top: 12px;
}

.settingsButtonL3 {
	top: 18px;
}

.searchOptions {
	position: absolute;
	z-index: 10;
	height: 210px;
	visibility: hidden !important;
	-webkit-transform: translate3d(0, -300px, 0);
	-webkit-transition-property: -webkit-transform, visibility;
	-webkit-transition-duration: 0.5s;
	transform: translate3d(0, -300px, 0);
	transition-property: transform, visibility;
	transition-duration: 0.5s;
	background-color: white;
}

.searchOptions.visible {
	visibility: visible !important;
	-webkit-transform: translate3d(0, 0, 0);
	transform: translate3d(0, 0, 0);
}

.searchOptions .mblEdgeToEdgeList {
	margin-bottom: 6px;
	font-size: 12pt;
}

.searchOptions .mblListItem {
	height: 44px;
	line-height: 44px;
}

.searchOptions .mblListItem .mblSwitch {
	top: 9px;
}

.searchOptions .searchEngineSelect {
	position: absolute;
	right: 12px;
	top: 7px;
	width: 190px;
	height: 30px;
	line-height: 30px;
	border: none;
	-webkit-appearance: none;
	color: #007aff;
	background: white;
}

.searchOptions .searchEngineSelect:focus {
	outline: none;
}

.searchOptions div.searchEngineSelect {
	width: 160px;
	padding-right: 29px;
	pointer-events: none;
	text-align: right;
}

.searchOptions div.searchEngineSelectArrow {
	pointer-events: none;
	position: absolute;
	right: 18px;
	top: 13px;
	width: 10px;
	height: 10px;
	border-width: 3px 3px 0px 0px;
	border-style: solid;
	border-color: #007aff;
	transform: rotate(135deg);
	-webkit-transform: rotate(135deg);
	position: absolute;
}

.searchButtonParent {
	position: absolute;
	left: 50%;
	right: 9px;
	margin-left: 6px;
}

.searchButton {
	position: absolute;
	width: 100%;
	left: 0;
	top: 0;
	font-size: medium;
	height: 40px;
	background: #215fdc;
	color: white;
	font-size: medium;
}

.searchButton:active {
	background: #8ea4c1;
}

.cancelSearchButtonParent {
	position: absolute;
	left: 9px;
	right: 50%;
	margin-right: 6px;
}

.cancelSearchButton {
	position: absolute;
	width: 100%;
	left: 0;
	top: 0;
	font-size: medium;
	height: 40px;
	background-color: #c5ccd3;
}

.cancelSearchButton:active {
	background: #dedede;
}

.settingsLabel {
	font-weight: bold;
	color: #606080;
	margin-left: 12px;
	margin-top: 12px;
	margin-bottom: 3px;
}

.versionLabel {
	font-weight: normal;
	font-style: italic;
	font-size: 10pt;
	color: #606080;
	margin-top: 18px;
	margin-bottom: 9px;
	text-align: center;
}

#settings .mblRoundRectList {
	margin-top: 9px;
	margin-bottom: 12px;
}

.settingsSpacer {
	height: 1px;
}

.inlineTextBox {
	position: absolute;
	top: 9px;
	right: 6px;
	border: none;
	z-index: 2;
	text-align: right;
	width: 180px;
	font-size: large;
	padding-right: 9px;
}

.inlineLabel {
	position: absolute;
	top: 0px;
	right: 6px;
	border: none;
	z-index: 2;
	text-align: right;
	width: 180px;
	font-size: medium;
	padding-right: 9px;
	color: #606080;
}

.inlineNumberBox {
	width: 50px;
}

.replyItem {
	color: #324f85;
	font-size: small;
}

.connectButton {
	float: right !important;
}

#connectButton {
	margin-right: -12px;
}

.connectButton.disabled {
	opacity: 0.5;
}

.mblDomButtonTransparent20 {
	position: relative;
	width: 20px;
	height: 20px;
}

.deleteButton {
	position: absolute;
	left: 9px;
	right: 9px;
	font-size: medium;
	height: 40px;
	background: #ed4d15;
	color: white;
}

.deleteButton:active {
	background: #c1a48e;
}

.indentedItem {
	padding-left: 27px;
}

.itemDisabler {
	display: none;
	position: absolute;
	left: 0;
	top: 0;
	right: 0;
	bottom: 0;
	background: white;
	top: 0;
	right: 0;
	bottom: 0;
	background: white;
	opacity: 0.7;
	z-index: 10;
	right: 0;
	bottom: 0;
	background: white;
	top: 0;
	right: 0;
	bottom: 0;
	background: white;
	right: 0;
}

.disabled .itemDisabler {
	display: block;
}

.articleView {
	visibility: hidden !important;
	height: 100%;
}

.imageBackground,.textView,.videoView {
	visibility: hidden;
}

.image .imageBackground {
	visibility: visible;
}

.text .textView {
	visibility: visible;
}

.video .videoView {
	visibility: visible;
}

.indexView {
	height: 100%;
}

.articleTitleBg,.indexTitleBg {
	position: absolute;
	top: 0;
	left: 0;
	right: 0;
	height: 44px;
	background-image: -webkit-gradient(linear, left top, left bottom, from(#b0bccd),
		to(#6d84a2), color-stop(0.5, #889bb3), color-stop(0.5, #8195af));
	-moz-background-image: linear-gradient(to bottom, #b0bccd, #889bb3 50%, #8195af 50%, #6d84a2);
	opacity: 0.2;
}

.articleTitleLabel,.indexTitleLabel {
	position: absolute;
	top: 0px;
	left: 65px;
	right: 65px;
	color: #d0d0d0;
	font-size: small;
	font-family: sans-serif;
	font-weight: bold;
	text-align: center;
	vertical-align: middle;
	height: 44px;
	line-height: 44px;
	white-space: nowrap;
	overflow: hidden;
	text-overflow: ellipsis;
}

.articleBackButton {
	position: absolute;
	top: -1px;
	left: -3px;
	top: -1px;
	font-size: 13px;
	font-weight: bold;
	pointer-events: all !important;
}

.indexButton {
	position: absolute;
	top: 5px;
	right: 35px;
	width: 22px;
	height: 22px;
	padding: 0;
	pointer-events: all !important;
}

.indexButton .indexButtonDiv {
	position: absolute;
	width: 8px;
	height: 8px;
	background-color: rgba(0, 122, 255, 0.5);
}

.indexButton .indexButtonDiv1 {
	top: 0;
	left: 0;
}

.indexButton .indexButtonDiv2 {
	top: 0;
	left: 12px;
}

.indexButton .indexButtonDiv3 {
	top: 12px;
	left: 0;
}

.indexButton .indexButtonDiv4 {
	top: 12px;
	left: 12px;
}

.textButton {
	position: absolute;
	top: 3px;
	right: 3px;
	font-size: 12px;
	width: 22px;
	height: 22px;
	line-height: 22px;
	font-family: times;
	font-weight: bold;
	border-color: rgba(0, 122, 255, 0.5);
	border-width: 1px;
	border-style: solid;
	padding: 0;
	pointer-events: all !important;
}

.textButton.disabled {
	opacity: 0.5;
}

.imageBackground {
	background: black;
	width: 100%;
	height: 100%;
}

.articleImage {
	position: absolute;
	-webkit-user-select: none;
	user-select: none;
	-webkit-transform-origin: 0 0;
	-webkit-perspective: 1000;
	-webkit-backface-visibility: hidden;
	-webkit-perspective: 1000;
	transform-origin: 0 0;
	perspective: 1000;
	backface-visibility: hidden;
	perspective: 1000;
	background-color: #808080;
	visibility: hidden;
}

.articleControls,.indexControls {
	position: absolute;
	top: 0;
	left: 0;
	width: 100%;
	height: 100%;
	-webkit-transition: opacity 1s, visibility 1s;
	transition: opacity 1s, visibility 1s;
	opacity: 1;
	visibility: visible;
	left: 0;
	pointer-events: none !important;
}

.articleControls.hidden,.indexControls.hidden {
	opacity: 0;
	visibility: hidden;
}

.arrowContainer {
	position: absolute;
	top: 0px;
	bottom: 0px;
	height: 100%;
	width: 50px;
	background: rgba(1, 1, 1, 0.01);
	height: 100%;
	pointer-events: all !important;
}

.leftArrowContainer {
	left: 0;
}

.rightArrowContainer {
	right: 0;
}

.articleArrow {
	position: absolute;
	border-left-color: #909090;
	border-left-style: solid;
	border-left-width: 10px;
	border-top-color: #909090;
	border-top-style: solid;
	border-top-width: 10px;
	width: 50px;
	height: 50px;
	top: 50%;
	margin-top: -30px;
}

@
-webkit-keyframes blink {from { border-left-color:#404040;
	border-top-color: #404040;
}

to {
	border-left-color: #d0d0d0;
	border-top-color: #d0d0d0;
}

}
.articleArrow.slideshow {
	-webkit-animation-name: blink;
	-webkit-animation-duration: 0.4s;
	-webkit-animation-iteration-count: infinite;
	-webkit-animation-direction: alternate;
	-webkit-animation-timing-function: linear;
}

.leftArrow {
	left: 0px;
	-webkit-transform: scale(0.5, 1) rotate(-45deg);
	transform: scale(0.5, 1) rotate(-45deg);
}

.rightArrow {
	right: 0px;
	-webkit-transform: scale(0.5, 1) rotate(135deg);
	transform: scale(0.5, 1) rotate(135deg);
}

.articleMessage {
	position: absolute;
	top: 50%;
	left: 20%;
	width: 60%;
	height: 100px;
	margin-top: -50px;
	visibility: visible;
	pointer-events: none !important;
}

.articleMessage.hidden {
	visibility: hidden;
}

.articleMessageText {
	position: absolute;
	left: 0;
	right: 0;
	color: white;
	top: 50%;
	margin-top: -12px;
	text-align: center;
	font-family: sans-serif;
	font-size: 14pt;
	font-weight: bold;
	right: 0;
}

.seriesMessage {
	position: absolute;
	right: 5px;
	top: 50px;
	padding: 5px 20px 5px 5px;
	color: #007AFF; //
	border: 1px solid rgba(0, 122, 255, 0.4);
	background: rgba(109, 138, 162, 0.2);
	font-size: 13px;
	font-weight: bold;
	visibility: visible;
	cursor: pointer;
	pointer-events: all !important;
}

.seriesMessage::before {
	content: "View all ";
}

.seriesMessage::after {
	content: "";
	position: absolute;
	border-left-color: #007AFF;
	border-left-style: solid;
	border-left-width: 3px;
	border-top-color: #007AFF;
	border-top-style: solid;
	border-top-width: 3px;
	width: 10px;
	height: 10px;
	right: 4px;
	bottom: 6px;
	-webkit-transform: scale(0.7, 0.8) rotate(135deg);
	transform: scale(0.7, 0.8) rotate(135deg);
}

.seriesMessage.hidden {
	visibility: hidden;
}

.imageScroller {
	width: auto;
	height: auto;
}

.indexView {
	background: black;
}

.indexView .mblHeading {
	background: #202020;
	border: none;
	color: #d0d0d0;
}

.indexView .mblHeading * {
	font-size: 13px;
	font-weight: bold;
}

.pauseButton {
	position: absolute;
	top: 3px;
	right: 60px;
	padding: 0;
}

.upDownButton {
	position: absolute;
	top: 3px;
	right: 40px;
	padding: 0;
}

.clearButton {
	position: absolute;
	top: 3px;
	right: 0px;
	padding: 0;
}

.clearButton.disabled {
	opacity: 0.5;
}

.indexParent {
	width: 100%;
}

.indexThumbnailParent {
	background-color: #000000;
	text-align: center;
	display: inline-block;
	vertical-align: middle;
	position: relative;
	cursor: pointer;
	font-size: x-small;
	color: #c0c0c0;
	text-align: center;
}

.indexThumbnailName {
	position: absolute;
	left: 0;
	right: 0;
	font-size: x-small;
	color: #c0c0c0;
	text-align: center;
}

.indexThumbnail {
	vertical-align: middle;
}

.zoomDiv {
	color: #909090;
	position: absolute;
	left: 3px;
	bottom: 3px;
}

.progressBarParent {
	visibility: hidden;
	opacity: 0;
	-webkit-transition-property: visibility, opacity;
	-webkit-transition-duration: 0.5s;
	-webkit-transition-delay: 0.3s;
	transition-property: visibility, opacity;
	transition-duration: 0.5s;
	transition-delay: 0.3s;
	position: absolute;
	height: 40px;
	position: absolute;
	background: none;
	left: 0px;
	right: 0px;
	bottom: 0px;
}

.progressBarParent.visible {
	visibility: visible;
	opacity: 1;
}

.progressBar {
	position: absolute;
	top: 15px;
	left: 15px;
	right: 15px;
}

.mblProgressBarMsg {
	top: 5px !important;
	font-size: x-small;
	color: #c0c0c0;
}

.textView {
	position: absolute;
	background: white;
}

.bodyButton {
	visibility: hidden;
	position: absolute;
	right: 0;
	padding-right: 0;
}

.showArticleText .bodyButton {
	visibility: visible;
}

.mblHeading .mblHeadingDivTitle,.mblHeading .mblHeadingSpanTitle {
	font-family: sans-serif;
	font-weight: bold;
	font-size: 11pt !important;
}

.mblHeading .mblToolBarButton {
	font-size: 11pt;
	font-weight: bold;
	margin-bottom: 9px;
}

.smallHeading .mblToolBarButton {
	font-size: 13px;
	font-weight: bold;
}

.smallHeading .mblHeadingDivTitle {
	display: block !important;
	width: auto;
	right: 0;
	white-space: nowrap;
	overflow: hidden;
	text-overflow: ellipsis;
	left: 65px;
	font-size: small !important;
	padding-top: 1px;
}

.ngSearchBoxParent {
	position: absolute;
	top: 6px;
	right: 6px;
	width: 100px;
}

.ngSearchIcon {
	position: absolute;
	right: 110px;
	top: 11px;
}

.ngSearchBox {
	position: absolute;
	right: 0;
	top: 2px;
	width: 100%;
	border: none;
	height: 20px;
	padding-left: 27px;
	padding-right: 7px;
	padding-top: 4px;
	padding-bottom: 4px;
	border-radius: 6px;
}

.newsgroupHeading .mblHeadingDivTitle {
	right: 100px;
}

.dj_iphone .ngSearchBox {
	padding-top: 2px;
	height: 22px;
}

@media ( max-width : 320px) {
	.ngSearchBoxParent {
		width: 50px;
	}
	.newsgroupHeading .mblHeadingDivTitle {
		right: 50px;
	}
	.ngSearchIcon {
		right: 60px;
	}
}

.showArticleText .smallHeading .mblHeadingDivTitle {
	right: 80px;
}

.smallHeading .mblHeadingSpanTitle {
	display: none !important;
}

.headerTable {
	padding-top: 6px;
	padding-left: 9px;
}

.headerRow {
	background: white;
	font-size: small;
}

.headerLabel {
	font-weight: bold;
}

.textRect {
	padding-left: 12px;
	padding-right: 12px;
	background: white;
	font-size: small;
}

.videoView {
	display: block;
	position: absolute;
	background: black;
	height: 100%;
}

.video {
	position: absolute;
}

.grayItem {
	color: gray;
}

.mblEdgeToEdgeList .mblListItem.series div.similar {
	font-weight: normal;
	font-style: italic;
	color: blue;
	line-height: 11pt;
	margin-top: 5px;
}

.mblEdgeToEdgeList .mblListItem.series.obsolete div.similar {
	text-decoration: line-through;
}

.mblEdgeToEdgeList .mblListItem .listThumbnailParent {
	float: right;
	width: 40px;
	height: 40px;
	line-height: 39px;
	text-align: center;
	margin: -10px 0 -10px 5px;
}

.mblEdgeToEdgeList .mblListItem .listThumbnailImage {
	max-width: 40px;
	max-height: 40px;
	vertical-align: middle;
}

</style>

</head>

<body style="visibility: hidden;" onresize="resize()">
	<div data-dojo-type="dojox/mobile/ScrollableView" id="search"
		data-dojo-id="searchView" data-dojo-props="selected:true">
		<div data-dojo-type="dojox/mobile/Heading" class="searchHeading"
			data-dojo-props="fixed:'top'">
			<div class="searchBoxParent">
				<input data-dojo-type="dojox/mobile/TextBox" class="searchBox"
					data-dojo-id="searchBox" onfocus="searchFocus()"
					onblur="searchBlur()">
			</div>
			<div class="searchIcon mblDomButtonGreySearch">
				<div>
					<div></div>
				</div>
			</div>
			<div class="clearIcon" id="clearIcon" onclick="clearSearchBox()">
				<div class="clearIconDiv1"></div>
				<div class="clearIconDiv2"></div>
			</div>
			<div data-dojo-type="dojox/mobile/ToolBarButton"
				data-dojo-props="moveTo:'settings',transition:'slide'"
				class="settingsButton">
				<div class="settingsButtonL1"></div>
				<div class="settingsButtonL2"></div>
				<div class="settingsButtonL3"></div>
			</div>
		</div>
		<div class="searchOptions" data-dojo-type="dojox/mobile/View"
			data-dojo-id="searchOptions">
			<ul data-dojo-type="dojox/mobile/EdgeToEdgeList">
				<li data-dojo-type="dojox/mobile/ListItem" tabIndex="-1">Browse
					newsgroups<span data-dojo-id="browseSwitch"
					data-dojo-type="dojox/mobile/Switch"
					data-dojo-props="onStateChanged:updateSearchSettings"></span>
				</li>
				<li data-dojo-type="dojox/mobile/ListItem" tabIndex="-1"
					data-dojo-props="label:'Filter'"><input
					data-dojo-id="filterBox" data-dojo-type="dojox/mobile/TextBox"
					class="inlineTextBox"
					data-dojo-props="placeHolder:'filter',onChange:updateSearchSettings"
					onfocus="searchFocus()" onblur="searchBlur()"></input>
					<div class="itemDisabler"></div></li>
				<li data-dojo-type="dojox/mobile/ListItem" tabIndex="-1">Search
					engine: <select id="searchEngineSelect" class="searchEngineSelect"
					onchange="updateSearchSettings()" tabIndex="-1"
					onfocus="searchFocus()" onblur="searchBlur()">
						<option value="NZBIndex">NZBIndex</option>
						<option value="BinSearch2">BinSearch</option>
						<option value="BinSearch1">BinSearch (most pop.)</option>
				</select>
					<div id="searchEngineDiv" class="searchEngineSelect"></div>
					<div class="searchEngineSelectArrow"></div>
					<div class="itemDisabler"></div>
				</li>
			</ul>
			<div class="searchButtonParent">
				<button data-dojo-type="dojox/mobile/Button" class="searchButton"
					data-dojo-props="label:'Search',onClick:search,duration:0"></button>
			</div>
			<div class="cancelSearchButtonParent">
				<button data-dojo-type="dojox/mobile/Button"
					class="cancelSearchButton"
					data-dojo-props="label:'Cancel',onClick:cancelSearch,duration:0"></button>
			</div>
		</div>
		<ul data-dojo-type="dojox/mobile/EdgeToEdgeList"
			data-dojo-props="variableHeight:true"
			data-dojo-id="searchResultsList" id="searchResultsList"
			data-dojo-mixins="dojox/mobile/LongListMixin">
		</ul>
	</div>
	<div data-dojo-type="dojox/mobile/ScrollableView" id="newsgroup"
		data-dojo-id="newsgroupView"
		data-dojo-props="onBeforeTransitionOut:leaveNewsgroupView">
		<div data-dojo-type="dojox/mobile/Heading"
			class="newsgroupHeading smallHeading" data-dojo-id="newsgroupHeading"
			data-dojo-props="fixed:'top',back:'Search',moveTo:'search'">
			<div class="ngSearchBoxParent">
				<input data-dojo-type="dojox/mobile/TextBox" class="ngSearchBox"
					data-dojo-id="ngSearchBox" onchange="newsgroupSearch()">
			</div>
			<div class="ngSearchIcon mblDomButtonGreySearch">
				<div>
					<div></div>
				</div>
			</div>
		</div>
		<ul data-dojo-type="dojox/mobile/EdgeToEdgeList"
			data-dojo-props="variableHeight:true"
			data-dojo-id="newsgroupResultsList" id="newsgroupResultsList"
			data-dojo-mixins="dojox/mobile/LongListMixin">
		</ul>
	</div>
	<div data-dojo-type="dojox/mobile/ScrollableView" id="series"
		data-dojo-id="seriesView"
		data-dojo-props="onBeforeTransitionOut:leaveSeriesView">
		<div data-dojo-type="dojox/mobile/Heading"
			class="seriesHeading smallHeading" data-dojo-id="seriesHeading"
			data-dojo-props="fixed:'top',back:'Back',moveTo:'search'"></div>
		<ul data-dojo-type="dojox/mobile/EdgeToEdgeList"
			data-dojo-props="variableHeight:true"
			data-dojo-id="seriesResultsList" id="seriesResultsList"
			data-dojo-mixins="dojox/mobile/LongListMixin">
		</ul>
	</div>
	<div data-dojo-type="dojox/mobile/ScrollableView" id="series2"
		data-dojo-id="seriesView2"
		data-dojo-props="onBeforeTransitionOut:leaveSeriesView">
		<div data-dojo-type="dojox/mobile/Heading"
			class="seriesHeading smallHeading" data-dojo-id="seriesHeading2"
			data-dojo-props="fixed:'top',back:'Back',moveTo:'search'"></div>
		<ul data-dojo-type="dojox/mobile/EdgeToEdgeList"
			data-dojo-props="variableHeight:true"
			data-dojo-id="seriesResultsList2" id="seriesResultsList2"
			data-dojo-mixins="dojox/mobile/LongListMixin">
		</ul>
	</div>
	<div data-dojo-type="dojox/mobile/View" id="article"
		class="articleView" data-dojo-id="articleView"
		data-dojo-props="onBeforeTransitionOut:leaveArticleView"
		onclick="showArticleControls()"
		onmousemove="showArticleControls(event)">
		<div class="imageBackground" id="imageBackground">
			<div data-dojo-type="dojox/mobile/ScrollableView"
				class="imageScroller" data-dojo-id="imageScroller"
				data-dojo-props="scrollDir:'h'">
				<img id="articleImage" class="articleImage" onload="fitImage()"
					onerror="imageError()">
			</div>
			<div id="zoomDiv" class="zoomDiv"></div>
		</div>
		<div class="textView" data-dojo-type="dojox/mobile/ScrollableView"
			data-dojo-id="textView"
			data-dojo-props="scrollDir:'vh',height:'inherit'">
			<div data-dojo-type="dojox/mobile/Heading" data-dojo-id="textHeading"
				class="smallHeading"
				data-dojo-props="back:'Back',moveTo:'search',fixed:'top'">
				<div data-dojo-type="dojox/mobile/ToolBarButton" class="bodyButton"
					data-dojo-props="label: 'Attachment', onClick: showArticleBody"></div>
			</div>
			<table class="headerTable">
				<tr class="headerRow">
					<td class="headerLabel">From:</td>
					<td id="from" class="headerValue"></td>
				</tr>
				<tr class="headerRow">
					<td class="headerLabel">Date:</td>
					<td id="date" class="headerValue"></td>
				</tr>
				<tr class="headerRow">
					<td class="headerLabel">Newsgroups:</td>
					<td id="newsgroups" class="headerValue"></td>
				</tr>
			</table>
			<div id="textRect" class="textRect"></div>
		</div>
		<div class="videoView" data-dojo-type="dojox/mobile/View"
			data-dojo-id="videoView">
			<div data-dojo-type="dojox/mobile/Heading"
				data-dojo-id="videoHeading" class="smallHeading"
				data-dojo-props="back:'Back',moveTo:'search',fixed:'top'"></div>
			<video id="video" class="video" controls autoplay></video>
		</div>
		<div id="articleControls" class="articleControls hidden">
			<div id="leftArrow" class="arrowContainer leftArrowContainer"
				onclick="previous()">
				<div class="articleArrow leftArrow" id="leftArrowDiv"></div>
			</div>
			<div id="articleTitleBg" class="articleTitleBg"></div>
			<div id="articleTitleLabel" class="articleTitleLabel"></div>
			<div id="rightArrow" class="arrowContainer rightArrowContainer"
				onclick="next()">
				<div class="articleArrow rightArrow" id="rightArrowDiv"></div>
			</div>
			<div data-dojo-type="dojox/mobile/ToolBarButton"
				data-dojo-id="articleBackButton" class="articleBackButton"
				data-dojo-props="moveTo:'search',transition:'slide',transitionDir:-1,arrow:'left',label:'Back'">
			</div>
			<div data-dojo-type="dojox/mobile/ToolBarButton" class="indexButton"
				data-dojo-props="onClick: showThumbnails">
				<div class="indexButtonDiv indexButtonDiv1"></div>
				<div class="indexButtonDiv indexButtonDiv2"></div>
				<div class="indexButtonDiv indexButtonDiv3"></div>
				<div class="indexButtonDiv indexButtonDiv4"></div>
			</div>
			<div data-dojo-type="dojox/mobile/ToolBarButton" class="textButton"
				data-dojo-id="textButton"
				data-dojo-props="label: 'T', onClick: showArticleText"></div>
			<div id="seriesMessage" class="seriesMessage hidden"
				onclick="viewSeries()"></div>
		</div>
		<div id="articleMessage" class="articleMessage hidden">
			<div id="articleMessageText" class="articleMessageText"></div>
		</div>
		<div id="progressBarParent" class="progressBarParent">
			<div data-dojo-type="dojox/mobile/ProgressBar"
				data-dojo-id="progressBar" class="progressBar"></div>
		</div>
	</div>
	<div data-dojo-type="dojox/mobile/ScrollableView" id="index"
		class="indexView" data-dojo-id="indexView"
		data-dojo-props="onBeforeTransitionOut:leaveIndexView">
		<div data-dojo-type="dojox/mobile/Heading" data-dojo-id="indexHeading"
			data-dojo-props="fixed:'top',label:'Index',moveTo:'article',back:'Back'">
			<div data-dojo-type="dojox/mobile/ToolBarButton"
				class="pauseButton pause" id="pauseButton"
				data-dojo-id="pauseButton"
				data-dojo-props="onClick: pauseResumeThumbnails, label:'Pause'">
			</div>
			<div data-dojo-type="dojox/mobile/ToolBarButton" class="upDownButton"
				id="upDownButton" data-dojo-id="upDownButton"
				data-dojo-props="onClick: toggleThumbnailsDir, label:'▲'"></div>
			<div data-dojo-type="dojox/mobile/ToolBarButton"
				class="clearButton disabled" id="clearButton"
				data-dojo-id="clearButton"
				data-dojo-props="onClick: clearThumbnails, label:'Clear'"></div>
		</div>
		<div id="indexParent" class="indexParent"></div>
	</div>
	<div data-dojo-type="dojox/mobile/ScrollableView" id="settings"
		data-dojo-id="settingsView"
		data-dojo-props="onBeforeTransitionOut:cancelRequest">
		<div data-dojo-type="dojox/mobile/Heading"
			data-dojo-props="fixed:'top',label:'Settings',moveTo:'search',back:'Done'"></div>
		<p class="settingsLabel">Usenet server</p>
		<ul data-dojo-type="dojox/mobile/EdgeToEdgeList"
			data-dojo-id="serverList">
			<li data-dojo-type="dojox/mobile/ListItem" tabIndex="-1"
				data-dojo-props="label:'New...',moveTo:'server',userClickAction:editServer"></li>
		</ul>
		<p class="settingsLabel">Search</p>
		<ul data-dojo-type="dojox/mobile/EdgeToEdgeList">
			<li data-dojo-type="dojox/mobile/ListItem" tabIndex="-1"
				data-dojo-props="label:'Search results'"><input
				data-dojo-id="resultsCountBox" data-dojo-type="dojox/mobile/TextBox"
				class="inlineTextBox inlineNumberBox"
				data-dojo-props="placeHolder:'number of search results',onChange:updateSearchSettings">
			</li>
			<li data-dojo-type="dojox/mobile/ListItem" tabIndex="-1"
				data-dojo-props="label:'Timeout getting headers'"><input
				data-dojo-id="getHeadersTimeoutBox"
				data-dojo-type="dojox/mobile/TextBox"
				class="inlineTextBox inlineNumberBox"
				data-dojo-props="placeHolder:'search timeout (seconds)',onChange:updateSearchSettings">
			</li>
		</ul>
		<p class="settingsLabel">Application State</p>
		<ul data-dojo-type="dojox/mobile/EdgeToEdgeList">
			<li data-dojo-type="dojox/mobile/ListItem" tabIndex="-1">Remember
				state<span data-dojo-id="stateSwitch"
				data-dojo-type="dojox/mobile/Switch"
				data-dojo-props="onStateChanged:updateStateSettings"></span>
			</li>
			<li data-dojo-type="dojox/mobile/ListItem" tabIndex="-1">Using
				<div id="stateUsing" class="inlineLabel"></div>
			</li>
		</ul>
		<p class="settingsLabel">Article Loading</p>
		<ul data-dojo-type="dojox/mobile/EdgeToEdgeList">
			<li data-dojo-type="dojox/mobile/ListItem" tabIndex="-1">Show
				progress<span data-dojo-id="asyncSwitch"
				data-dojo-type="dojox/mobile/Switch"
				data-dojo-props="onStateChanged:updateLoadSettings"></span>
			</li>
			<li data-dojo-type="dojox/mobile/ListItem" tabIndex="-1"
				class="indentedItem">Progress bar<span
				data-dojo-id="progressSwitch" data-dojo-type="dojox/mobile/Switch"
				data-dojo-props="onStateChanged:updateLoadSettings"></span>
				<div class="itemDisabler"></div>
			</li>
			<li data-dojo-type="dojox/mobile/ListItem" tabIndex="-1"
				class="indentedItem">Partial image<span
				data-dojo-id="partialSwitch" data-dojo-type="dojox/mobile/Switch"
				data-dojo-props="onStateChanged:updateLoadSettings"></span>
				<div class="itemDisabler"></div>
			</li>
			<li data-dojo-type="dojox/mobile/ListItem" tabIndex="-1">Optimize
				image download <span data-dojo-id="optimizeImageDownloadSwitch"
				data-dojo-type="dojox/mobile/Switch"
				data-dojo-props="onStateChanged:updateLoadSettings"></span>
				<div class="itemDisabler"></div>
			</li>
		</ul>
		<p class="settingsLabel">Thumbnails</p>
		<ul data-dojo-type="dojox/mobile/EdgeToEdgeList">
			<li data-dojo-type="dojox/mobile/ListItem" tabIndex="-1"
				data-dojo-props="label:'Thumbnail size'"><input
				data-dojo-id="thumbnailSizeBox"
				data-dojo-type="dojox/mobile/TextBox"
				class="inlineTextBox inlineNumberBox"
				data-dojo-props="placeHolder:'default 100',onChange:updateThumbnailsSettings">
			</li>
			<li data-dojo-type="dojox/mobile/ListItem" tabIndex="-1">Show thumbnails in list
				<span data-dojo-id="listThumbnailsSwitch"
				data-dojo-type="dojox/mobile/Switch"
				data-dojo-props="onStateChanged:updateThumbnailsSettings"></span>
				<div class="itemDisabler"></div>
			</li>
		</ul>
		<p class="settingsLabel">Slideshow</p>
		<ul data-dojo-type="dojox/mobile/EdgeToEdgeList">
			<li data-dojo-type="dojox/mobile/ListItem" tabIndex="-1"
				data-dojo-props="label:'Delay'"><input
				data-dojo-id="slideshowDelayBox"
				data-dojo-type="dojox/mobile/TextBox"
				class="inlineTextBox inlineNumberBox"
				data-dojo-props="placeHolder:'default 100',onChange:updateSlideshowSettings">
			</li>
		</ul>
		<p class="versionLabel">Ni! - Version 5.6.2 - &copy; 2015 Mobile
			Factory</p>
		<div class="settingsSpacer"></div>
	</div>
	<div data-dojo-type="dojox/mobile/View" id="server"
		data-dojo-id="serverView">
		<div data-dojo-type="dojox/mobile/Heading"
			data-dojo-props="label:'Server'">
			<span data-dojo-type="dojox/mobile/ToolBarButton"
				data-dojo-props="label:'Cancel',moveTo:'settings',transition:'slide', transitionDir:-1"
				class="cancelButton"> </span> <span
				data-dojo-type="dojox/mobile/ToolBarButton" data-dojo-id="okButton"
				data-dojo-props="label:'OK',onClick:connect"
				class="connectButton disabled"> </span> <span
				data-dojo-type="dojox/mobile/ToolBarButton"
				data-dojo-id="connectButton" id="connectButton"
				data-dojo-props="label:'Connect',onClick:connect"
				class="connectButton disabled"> </span>
		</div>
		<ul data-dojo-type="dojox/mobile/EdgeToEdgeList">
			<li data-dojo-type="dojox/mobile/ListItem" tabIndex="-1"
				data-dojo-props="label:'Name'"><input data-dojo-id="nameBox"
				data-dojo-type="dojox/mobile/TextBox" class="inlineTextBox"
				data-dojo-props="placeHolder:'displayed in server list',onChange:nameBoxChanged"></input></li>
		</ul>
		<ul data-dojo-type="dojox/mobile/EdgeToEdgeList">
			<li data-dojo-type="dojox/mobile/ListItem" tabIndex="-1"
				data-dojo-props="label:'Host'"><input
				data-dojo-id="hostnameBox" data-dojo-type="dojox/mobile/TextBox"
				class="inlineTextBox"
				data-dojo-props="placeHolder:'e.g. news.acme.org',onChange:hostnameBoxChanged"></input></li>
			<li data-dojo-type="dojox/mobile/ListItem" tabIndex="-1"
				data-dojo-props="label:'Port'"><input data-dojo-id="portBox"
				data-dojo-type="dojox/mobile/TextBox"
				class="inlineTextBox inlineNumberBox"
				data-dojo-props="placeHolder:'default=119'"></input></li>
			<li data-dojo-type="dojox/mobile/ListItem" tabIndex="-1"
				data-dojo-props="label:'User name'"><input
				data-dojo-id="usernameBox" data-dojo-type="dojox/mobile/TextBox"
				class="inlineTextBox" data-dojo-props="placeHolder:'(if required)'"></input></li>
			<li data-dojo-type="dojox/mobile/ListItem" tabIndex="-1"
				data-dojo-props="label:'Password'"><input
				data-dojo-id="passwordBox" type="password"
				data-dojo-type="dojox/mobile/TextBox" class="inlineTextBox"
				data-dojo-props="placeHolder:'(if required)'"></input></li>
			<li data-dojo-type="dojox/mobile/ListItem" tabIndex="-1"
				data-dojo-props="label:'Retention'"><input
				data-dojo-id="retentionBox" data-dojo-type="dojox/mobile/TextBox"
				class="inlineTextBox inlineNumberBox"
				data-dojo-props="placeHolder:'default=1000 days'"></input></li>
		</ul>
		<p class="settingsLabel">Server reply:</p>
		<ul data-dojo-type="dojox/mobile/EdgeToEdgeList">
			<li data-dojo-type="dojox/mobile/ListItem" tabIndex="-1"
				data-dojo-id="replyItem" class="replyItem"></li>
		</ul>
		<button data-dojo-type="dojox/mobile/Button" class="deleteButton"
			data-dojo-id="deleteServerButton"
			data-dojo-props="label:'Forget this server',onClick:deleteServer,duration:0"></button>
	</div>
	<div data-dojo-id="msgDialog"
		data-dojo-type="dojox/mobile/SimpleDialog">
		<div id="msgText" class="mblSimpleDialogTitle"
			style="margin-bottom: 14px;"></div>
		<button data-dojo-type="dojox/mobile/Button"
			class="mblSimpleDialogButton mblBlueButton"
			data-dojo-props="onClick:function(){msgDialog.hide();}">OK</button>
	</div>
	<div data-dojo-type="dojox/mobile/ToolBarButton"
		data-dojo-id="invisibleButton" class="invisibleButton"></div>
	<div id="loadingScreen"></div>
</body>
</html>
